<!DOCTYPE html>
<!-- saved from url=(0083)https://labclient.labondemand.com/Instructions/e013c27b-7e28-4b7b-a514-ffe8a76c35a1 -->
<html lang="en-US" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>Build a serverless, AI RAG application using data from Azure Cosmos DB [New Parent]</title>
    <link rel="shortcut icon" href="https://labclient.labondemand.com/images/favicon-32x32.png">
    <script async="" src="./datadog-logs.js.download"></script><script async="" src="./pendo.js.download"></script><script src="./jquery.min(1).js.download"></script>
    <script src="./jquery-ui.min(1).js.download"></script>
    <script src="./showdown.min.js.download"></script>
    <link rel="stylesheet" type="text/css" href="./prettify.css">
    <script src="./yaml.min.js.download"></script>
    <script src="./jquery.timepicker.min.js.download"></script>
    <link rel="stylesheet" type="text/css" href="./jquery.timepicker.css">
    <script src="./LocalizeTo(1)" type="text/javascript"></script>
<script src="./CustomerSupportApp.js.download" type="text/javascript" script-src="" 'self'="" http:="" *="" https:="" 'unsafe-inline'="" 'unsafe-eval'=""></script><script src="./LocalizeTo(2)" type="text/javascript"></script>    <script src="./string-functions.js.download"></script>
    <script src="./LocalizeTo(3)" type="text/javascript"></script>
    <link href="./jquery-ui.css" rel="stylesheet">
    <link href="./lab-client-layout-v2.css" rel="stylesheet" type="text/css">
    <link id="themeStylesheet" href="./styles-v2" rel="stylesheet" type="text/css">


        <script src="./lab-client-api.js.download"></script>
</head>
<body class="instructions-client childClient integrated-layout">
    <div id="labClient" style="">
        <div class="lab-client-header" role="banner">

            <div class="header-left">
                <div class="theme-logo"></div>
                <div id="labName" class="lab-name" role="heading" aria-level="1">
                    <span id="instanceName" title="Build a serverless, AI RAG application using data from Azure Cosmos DB [New Parent]">Build a serverless, AI RAG application using data from Azure Cosmos DB [New Parent]</span>
                </div>
            </div>

                    <a href="https://labclient.labondemand.com/Instructions/e013c27b-7e28-4b7b-a514-ffe8a76c35a1#" id="exitMenuButton" class="exit-button icon-link" role="button" aria-label="Exit Lab" aria-expanded="false" title="Menu with options for exiting the lab, including saving and ending the lab.">Exit Lab</a>
                <div id="exitMenu" class="menu" role="menu" aria-label="Exit Menu" aria-haspopup="true" aria-expanded="false">
                        <div id="saveAndExit" class="menu-item save-button icon-link" tabindex="0" role="menuitem" aria-label="Save Progress And Exit">Save Progress And Exit</div>
                        <div id="exit" class="menu-item cancel-button icon-link" tabindex="0" role="menuitem" aria-label="End Lab">End Lab</div>
                </div>
        </div>

        <div class="tab-headings primary-color-low-opacity-border" role="navigation">
            <div id="tabHolder" class="tab-holder">
                    <a tabindex="0" class="tabHeading tab-heading primary-color-border selected" aria-selected="true" role="tab" aria-label="Instructions" data-target="instructionsTab" data-id="0">Instructions</a>
                    <a tabindex="0" class="tabHeading tab-heading primary-color-border " aria-selected="false" role="tab" aria-label="Resources" data-target="resourcesTab" data-id="1">Resources</a>
            </div>
            <div class="icon-holder">
                <a tabindex="0" id="notificationsButton" data-target="notifications-menu" class="notifications-button modal-menu-button icon primary-color-icon " role="button" aria-label="Notifications" title="Notifications"></a>
                    <a tabindex="0" data-target="help-menu" class="help-button modal-menu-button icon primary-color-icon" role="button" aria-label="Help" title="Help"></a>
                <a tabindex="0" data-target="settings-menu" class="settings-button modal-menu-button icon primary-color-icon" role="button" aria-label="Settings" title="Settings"></a>
            </div>
        </div>

        <div class="tabs" role="main">
            <div id="instructionsTab" class="tab selected">
                <div id="instructionsContent" class="tab-content withFooter instructions withTaskProgress withNavigation" aria-label="Lab Instructions">
                    <div class="zoomable" id="pages"><div class="page selected" id="page0"><h1 id="build-a-serverless-ai-rag-application-using-data-from-azure-cosmos-db">Build a serverless, AI RAG application using data from Azure Cosmos DB</h1>
<hr>
<h2 id="scenario">Scenario</h2>
<p>Cosmic Works Bike Company (CWBC) is a leading provider of bikes and e-bikes, headquartered in the Netherlands. With a workforce of 1,000-9,999 employees, CWBC has been at the forefront of creating innovative and reliable bikes for a global customer base. Riders today, however, expect more than just a well-crafted bike-they want intelligent guidance, be it for choosing the right bike, maintaining it properly, or finding the best routes.</p>
<p>By integrating AI and cloud services, CWBC created an assistant that answers typical user questions (like "How do I maintain my disc brakes?") alongside dynamic route recommendations. A retrieval augmented generation (RAG) approach helps the assistant pull accurate data from Cosmos DB, ensuring it only references real CWBC products and information.</p>
<p>In this exercise, you'll build serverless, AI RAG applications using .NET Aspire, Semantic Kernel, and Azure Cosmos DB with DiskANN and vector search. You'll implement Semantic Kernel Azure OpenAI extensions, NoSQL connectors, and semantic caching. You'll gain practical insights into how to design, build, deploy, and scale RAG pattern applications in Azure. The skills in this lab will give you a solid foundation to create your own generative AI applications. It's recommended to have C# or other programming language experience before completing this lab.</p>
<h2 id="objectives">Objectives</h2>
<p>After completing this lab, you'll be able to:</p>
<ul>
<li>Build serverless, AI RAG applications using .NET Aspire, Semantic Kernel, and Azure Cosmos DB with DiskANN and vector search.</li>
<li>Design, build, deploy, and scale RAG pattern applications in Azure.</li>
</ul>
<h2 id="duration">Duration</h2>
<p>Estimated time: <strong>150 minutes</strong></p>
</div><div class="page" id="page1">
<h1 id="sign-to-the-lab-vm">Sign to the lab VM</h1>
<p>Before you begin, sign in to the VM environment you'll use for the duration of this lab.</p>
<ul class="taskList">
<li class="task-list-item" id="taskIndex0"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex0"><span></span></label> Sign in to the machine using the credentials provided here.</p>
<table>
<thead>
<tr>
<th></th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Username</td>
<td><strong>Admin</strong></td>
</tr>
<tr>
<td>Password</td>
<td><span class="typeText" title="Type Text" tabindex="0" role="button">Passw0rd!</span></td>
</tr>
</tbody>
</table></li>
</ul>
</div><div class="page" id="page2">
<h1 id="task-01-setup-and-run-the-starter-web-application">Task 01: Setup and run the starter web application</h1>
<h2 id="introduction">Introduction</h2>
<p>Before CWBC's Intelligent Assistant can help customers with bike-related queries, you need to ensure the foundational environment is properly set up. This lets you confirm everything builds and runs as intended. Think of it as tightening the bolts on a new bike frame before a test ride.</p>
<h2 id="description">Description</h2>
<p>In this task, you'll set up authentication, verify your code builds successfully, and run the existing starter application. Once complete, you'll see a placeholder AI response in the chat UI.</p>
<h2 id="success-criteria">Success criteria</h2>
<ul>
<li>You authenticated to Azure, trusted the HTTPS development certificate, and ran the project without encountering any errors.</li>
<li>You launched the basic chat UI, which displayed a placeholder response in the conversation window.</li>
<li>You successfully accessed the .NET Aspire dashboard locally, confirming that the app is listening and reachable.</li>
</ul>
<h2 id="learning-resources">Learning resources</h2>
<ul>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/azure/cosmos-db/nosql/" target="_blank" aria-label="(opens a new window)">Azure Cosmos DB for NoSQL documentation</a>  </li>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/azure/ai-services/openai/overview" target="_blank" aria-label="(opens a new window)">Azure OpenAI Service - Overview</a>  </li>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/azure/active-directory/develop/authentication-scenarios" target="_blank" aria-label="(opens a new window)">Authentication with Microsoft Entra ID</a>  </li>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/aspnet/core/security/enforcing-ssl" target="_blank" aria-label="(opens a new window)">Configure HTTPS for ASP.NET Core</a>  </li>
</ul>
</div><div class="page" id="page3">
<h2 id="01-configure-authentication">01: Configure authentication</h2>
<p>CWBC values a secure-by-design approach-especially as the Intelligent Assistant will store private user data, product catalogs, and ride recommendations in Azure Cosmos DB. Proper authentication ensures only authorized personnel and processes can access these resources.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex1"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex1"><span></span></label> On your Windows task bar, select <strong>Terminal</strong>.</p></li>
<li class="task-list-item" id="taskIndex2"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex2"><span></span></label> Change the current working directory to where the application repository was cloned.</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">cd C</span><span class="pun">:</span><span class="pln">\Users\Admin\Repos\cosmosdb</span><span class="pun">-</span><span class="pln">nosql</span><span class="pun">-</span><span class="pln">copilot</span></code></p></li>
<li class="task-list-item" id="taskIndex3"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex3"><span></span></label> Open the project in Visual Studio Code with the following command.</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">code </span><span class="pun">.</span></code></p></li>
<li class="task-list-item" id="taskIndex4"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex4"><span></span></label> Within Visual Studio Code, open a new terminal by selecting <strong>Terminal</strong> on the top toolbar, then selecting <strong>New Terminal</strong>. Alternatively, select <strong>Ctrl+Shift+`</strong>.</p></li>
</ol>
<hr>
<h3 id="sign-in-to-azure">Sign in to Azure</h3>
<p>To access our Azure resources, you need to be authenticated from our terminal in Visual Studio Code. This application uses authentication with <a class="icon-link external-link" href="https://learn.microsoft.com/entra/identity/" target="_blank" aria-label="(opens a new window)">Microsoft Entra ID</a>. Role assignments have already been created for your user during resource deployment. </p>
<!-- If you're already signed in with the user credentials you used for deployment, skip to [Build and run the application for the first time.](#build-and-run-the-application-for-the-first-time) -->
<ol class="taskList">
<li class="task-list-item" id="taskIndex5"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex5"><span></span></label> Sign in to the Azure CLI by entering the following command in the terminal window inside of Visual Studio Code.</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">az login</span></code></p></li>
<li class="task-list-item" id="taskIndex6"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex6"><span></span></label> Select <strong>Work or school account</strong>, then select <strong>Continue</strong>.</p>
<blockquote class="alert">
  <p>The sign in window may open behind Visual Studio Code.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex7"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex7"><span></span></label> Sign in with your lab credentials:</p>
<table>
<thead>
<tr>
<th style="text-align:left;">Item</th>
<th style="text-align:left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">Username</td>
<td style="text-align:left;"><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">User1</span><span class="pun">-</span><span class="lit">55844333@LODSPRODMCA</span><span class="pun">.</span><span class="pln">onmicrosoft</span><span class="pun">.</span><span class="pln">com</span></code></td>
</tr>
<tr>
<td style="text-align:left;">Password</td>
<td style="text-align:left;"><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">NcQg</span><span class="pun">*</span><span class="pln">QUJ</span></code></td>
</tr>
</tbody>
</table></li>
<li class="task-list-item" id="taskIndex8"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex8"><span></span></label> Select <strong>No, this app only</strong>, when prompted.</p>
<p>
<img src="./sdnxmgro.jpg" alt="sdnxmgro.jpg"></p></li>
<li class="task-list-item" id="taskIndex9"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex9"><span></span></label> In the VS Code Terminal, select <strong>Enter</strong> to select the default subscription and tenant.</p></li>
</ol>
<hr>
<h3 id="grant-azure-permissions-to-your-account">Grant Azure permissions to your account</h3>
<p>Before you can run the applications locally within the security context of our Azure user you need to ensure it has permissions to the data in Azure Cosmos DB account and the endpoints of Azure Open AI account.  </p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex10"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex10"><span></span></label> Within Visual Studio Code terminal and change the current working directory to the scripts folder of this application.</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">cd </span><span class="pun">~</span><span class="str">/Repos/</span><span class="pln">cosmosdb</span><span class="pun">-</span><span class="pln">nosql</span><span class="pun">-</span><span class="pln">copilot</span><span class="pun">/</span><span class="pln">infra</span><span class="pun">/</span><span class="pln">scripts</span></code></p></li>
<li class="task-list-item" id="taskIndex11"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex11"><span></span></label> Open Microsoft Edge, then go to <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">portal</span><span class="pun">.</span><span class="pln">azure</span><span class="pun">.</span><span class="pln">com</span></code>.</p></li>
<li class="task-list-item" id="taskIndex12"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex12"><span></span></label> Sign in with your lab credentials:</p>
<table>
<thead>
<tr>
<th style="text-align:left;">Item</th>
<th style="text-align:left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">Username</td>
<td style="text-align:left;"><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">User1</span><span class="pun">-</span><span class="lit">55844333@LODSPRODMCA</span><span class="pun">.</span><span class="pln">onmicrosoft</span><span class="pun">.</span><span class="pln">com</span></code></td>
</tr>
<tr>
<td style="text-align:left;">Password</td>
<td style="text-align:left;"><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">NcQg</span><span class="pun">*</span><span class="pln">QUJ</span></code></td>
</tr>
</tbody>
</table></li>
<li class="task-list-item" id="taskIndex13"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex13"><span></span></label> Expand the portal menu near the upper-left corner of the page, then select <strong>Resource Groups</strong>.</p>
<p>
<img src="./rc1npqa6.jpg" alt="rc1npqa6.jpg"></p></li>
<li class="task-list-item" id="taskIndex14"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex14"><span></span></label> Select <strong>cosmosdb-nosql-copilot</strong>.</p>
<p>
<img src="./36nxa5yl.jpg" alt="36nxa5yl.jpg"></p></li>
<li class="task-list-item" id="taskIndex15"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex15"><span></span></label> On the resource group page, verify all the deployments have <strong>Succeeded</strong> under the <strong>Deployments</strong> property before proceeding forward.</p>
<p>
<img src="./hp4t1wqe.jpg" alt="hp4t1wqe.jpg"></p>
<blockquote class="alert">
  <p>If it's still deploying, wait until it's complete.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex16"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex16"><span></span></label> Close the browser window.</p></li>
<li class="task-list-item" id="taskIndex17"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex17"><span></span></label> Go to your VS Code terminal, then run the <strong>azd-role-assignments.sh</strong> script to grant permissions to your Azure user account.</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pun">./</span><span class="pln">azd</span><span class="pun">-</span><span class="pln">role</span><span class="pun">-</span><span class="pln">assignments</span><span class="pun">.</span><span class="pln">sh</span></code></p>
<blockquote class="note">
  <p>You can open the file in VS Code to see how this was written.</p>
</blockquote></li>
</ol>
</div><div class="page" id="page4">
<h2 id="02-build-and-run-the-application-for-the-first-time">02: Build and run the application for the first time</h2>
<p>CWBC wants to verify the project scaffolding is sound before introducing the real AI features.
Now that authentication is in place, you can run the initial version of the Intelligent Assistant to confirm everything compiles and the UI functions. </p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex18"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex18"><span></span></label> In the same terminal, change directories to <strong>src/cosmos-copilot.AppHost</strong>. </p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">cd </span><span class="pun">~</span><span class="str">/Repos/</span><span class="pln">cosmosdb</span><span class="pun">-</span><span class="pln">nosql</span><span class="pun">-</span><span class="pln">copilot</span><span class="pun">/</span><span class="pln">src</span><span class="pun">/</span><span class="pln">cosmos</span><span class="pun">-</span><span class="pln">copilot</span><span class="pun">.</span><span class="typ">AppHost</span></code></p>
<blockquote class="knowledge">
  <p>The <strong>AppHost</strong> is the entry point for all .NET Aspire projects and it acts as an orchestrator for all the dependent projects and services in your application.</p>
</blockquote><div class="moreKnowledge"><a href="https://labclient.labondemand.com/Instructions/e013c27b-7e28-4b7b-a514-ffe8a76c35a1#" class="moreKnowledgeLink">more...</a></div></li>
<li class="task-list-item" id="taskIndex19"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex19"><span></span></label> Before you run the application locally, you need to trust the https developer certificate that .NET will generate for us.</p>
<blockquote class="hint">
  <p>Using the <strong>Copy</strong> option and selecting <strong>Ctrl+V</strong> to paste into the VM will be faster than using <strong>Text</strong>. This will be more useful later on with long blocks of code.</p>
</blockquote>
<pre><div class="codeTitle"><span class="title">bash</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="bash language-bash prettyprint prettyprinted" tabindex="0" style=""><span class="pln">dotnet dev</span><span class="pun">-</span><span class="pln">certs https </span><span class="pun">--</span><span class="pln">clean
dotnet dev</span><span class="pun">-</span><span class="pln">certs https </span><span class="pun">--</span><span class="pln">trust</span></code></pre></li>
<li class="task-list-item" id="taskIndex20"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex20"><span></span></label> In the <strong>Security Warning</strong> dialog to install certificate, select <strong>Yes</strong>.</p>
<p>
<img src="./29hjf6lz.jpg" alt="29hjf6lz.jpg"></p></li>
<li class="task-list-item" id="taskIndex21"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex21"><span></span></label> At this point, your app has enough information to run but not enough to generate a real response from an LLM. Run the application to make sure your code doesn't have any omissions or errors.</p>
<pre><div class="codeTitle"><span class="title">bash</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="bash language-bash prettyprint prettyprinted" tabindex="0" style=""><span class="pln">dotnet workload restore
dotnet run</span></code></pre>
<blockquote class="note">
  <p>You may see some warnings in the terminal which are safe to ignore.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex22"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex22"><span></span></label> To test our application, launch the .NET Aspire dashboard by selecting <strong>Ctrl+click</strong> on the URL on the <strong>Login to the dashboard</strong> line.</p>
<p>
<img src="./qzzrpnbe.jpg" alt="qzzrpnbe.jpg"></p>
<blockquote class="note">
  <p>This will automatically open the .NET Aspire dashboard in a web browser.</p>
  <p>The .NET Aspire dashboard has pages to manage all project resources, view console output, structured logs, traces for each request, and metrics emitted by various libraries. </p>
</blockquote>
<blockquote class="alert">
  <p>If you get a "Your connection isn't private" message on the web browser, close all browser windows, then select <strong>Ctrl+click</strong> on the dashboard URL again.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex23"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex23"><span></span></label> On the dashboard, launch our chat application by selecting the <strong>http://localhost:8100</strong> endpoint.</p>
<p>
<img src="./264e3coh.jpg" alt="264e3coh.jpg"></p></li>
<li class="task-list-item" id="taskIndex24"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex24"><span></span></label> Select <strong>Create new chat</strong> on the left.</p>
<p>
<img src="./qwjz84fp.jpg" alt="qwjz84fp.jpg"></p></li>
<li class="task-list-item" id="taskIndex25"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex25"><span></span></label> Enter <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> are the most expensive bikes</span><span class="pun">?</span></code>, then select the send button.</p>
<p>
<img src="./dqyeh9f4.jpg" alt="dqyeh9f4.jpg"></p>
<blockquote class="note">
  <p>The AI assistant will respond with <strong>"Place holder response"</strong> and a token value of zero. We'll explain tokens in a later task.</p>
</blockquote>
<p>
<img src="./d92qn2mh.jpg" alt="d92qn2mh.jpg"></p></li>
<li class="task-list-item" id="taskIndex26"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex26"><span></span></label> Close the browser window.</p></li>
<li class="task-list-item" id="taskIndex27"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex27"><span></span></label> In the VS Code terminal, select <strong>Ctrl+C</strong> to shut down the application. Leave the terminal open.</p></li>
</ol>
<blockquote class="note">
  <p>Every time you run the application locally, we'll do it from the <strong>src/cosmos-copilot.AppHost</strong> directory you are already in. All updates to the application will be to files in the <strong>src/cosmos-copilot.WebApp</strong> directory and its folders.</p>
</blockquote>
<hr>
<p><strong>Congratulations!</strong> You've successfully completed this task.</p>
</div><div class="page" id="page5">
<h1 id="task-02-implement-the-semantic-kernel">Task 02: Implement the Semantic Kernel</h1>
<h2 id="introduction-1">Introduction</h2>
<p>CWBC's Intelligent Assistant must provide quick, intelligent responses for users asking about bike models, maintenance, and route tips. By integrating Semantic Kernel, you'll orchestrate calls to Azure OpenAI, turning the placeholders into real completions-key to meeting CWBC's advanced customer-service goals.</p>
<h2 id="description-1">Description</h2>
<p>In this task, you'll implement the Semantic Kernel Service to generate real responses from Azure OpenAI. </p>
<p>Semantic Kernel is an open-source SDK for LLM orchestration created by Microsoft Research. It lets you easily build agents that can call your existing code. As a highly extensible SDK, you can use Semantic Kernel with models from OpenAI, Azure OpenAI, Hugging Face, and more! You can also connect it to various vector databases using built-in connectors, including Azure Cosmos DB. </p>
<p>By combining your existing code with these models, you can build agents that answer questions and automate processes.</p>
<h2 id="success-criteria-1">Success criteria</h2>
<ul>
<li>You successfully replaced placeholder responses with real outputs generated by GPT from Azure OpenAI.</li>
<li>You ensured that the application compiles and runs smoothly, confirming that your integration of the Semantic Kernel is correct.</li>
</ul>
<h2 id="learning-resources-1">Learning resources</h2>
<ul>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/semantic-kernel/overview/" target="_blank" aria-label="(opens a new window)">Introduction to Semantic Kernel</a>  </li>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/semantic-kernel/ai-orchestration" target="_blank" aria-label="(opens a new window)">Understanding LLM Orchestration</a>  </li>
</ul>
</div><div class="page" id="page6">
<h2 id="01-add-the-openai-chat-completion-extension">01: Add the OpenAI Chat Completion extension</h2>
<p>To start, CWBC wants the Intelligent Assistant to handle user questions like "Which bikes are best for commuting?" You'll enable Azure OpenAI's Chat Completion to generate answers, the basis for advanced capabilities like context awareness.</p>
<p>In this task, you'll use two Semantic Kernel OpenAI Service Extensions and the Semantic Kernel Azure Cosmos DB NoSQL Vector Store connector. You'll start by adding the OpenAI Chat Completion extension to generate responses from the LLM.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex28"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex28"><span></span></label> Within the project folder in VS Code, find and open the file:</p>
<p><strong>src/cosmos-copilot.WebApp/Services/<code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">SemanticKernelService</span><span class="pun">.</span><span class="pln">cs</span></code></strong>:</p>
<p>
<img src="./04bv4iwl.jpg" alt="04bv4iwl.jpg"></p></li>
<li class="task-list-item" id="taskIndex29"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex29"><span></span></label> Select <strong>Ctrl+F</strong> to find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="typ">SemanticKernelService</span></code> constructor with the following signature: </p>
<p>
<img src="./2p91p2p0.jpg" alt="2p91p2p0.jpg"></p></li>
<li class="task-list-item" id="taskIndex30"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex30"><span></span></label> Select <strong>Ctrl+F</strong> to find the line containing <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">var</span><span class="pln"> builder </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Kernel</span><span class="pun">.</span><span class="typ">CreateBuilder</span><span class="pun">();</span></code> within that constructor. </p></li>
<li class="task-list-item" id="taskIndex31"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex31"><span></span></label> Below this line, add the extension for OpenAI chat completions:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">// Add Azure OpenAI chat completion service</span><span class="pln">
builder</span><span class="pun">.</span><span class="typ">AddOpenAIChatCompletion</span><span class="pun">(</span><span class="pln">modelId</span><span class="pun">:</span><span class="pln"> completionDeploymentName</span><span class="pun">,</span><span class="pln"> openAIClient</span><span class="pun">:</span><span class="pln"> openAiClient</span><span class="pun">);</span></code></pre>
<p>
<img src="./kutunlco.jpg" alt="kutunlco.jpg"></p>
<blockquote class="note">
  <p>The builder with this new line will initialize and inject a built-in service from OpenAI. <strong>Chat Completion</strong> refers to response generation from a GPT model.</p>
</blockquote>
<blockquote class="note">
  <p>This lab requires copying code from the instructions into Visual Studio Code. For proper formatting while copying code blocks longer than one line, you'll need to manually tab the 2nd+ lines of code. Multiple lines can be selected and tabbed.</p>
</blockquote></li>
</ol>
</div><div class="page" id="page7">
<h2 id="02-generate-chat-completion">02: Generate chat completion</h2>
<p>After wiring up chat completion, you can finally replace placeholder text with actual GPT outputs. This is the first time your Intelligent Assistant answers real questions, showcasing the AI-driven heart of CWBC's new approach to bike support.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex32"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex32"><span></span></label> In the same file, find line containing the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">GetChatCompletionAsync</span></code>() method. </p></li>
<li class="task-list-item" id="taskIndex33"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex33"><span></span></label> Within the method, below the line for <strong>var skChatHistory</strong>, add a new line to add the <strong>_systemPrompt</strong> value as a system message.</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">skChatHistory</span><span class="pun">.</span><span class="typ">AddSystemMessage</span><span class="pun">(</span><span class="pln">_systemPrompt</span><span class="pun">);</span></code></p>
<p>
<img src="./evd7miey.jpg" alt="evd7miey.jpg"></p>
<blockquote class="note">
  <p>You can find the <strong>_systemPrompt</strong> definition at the top of the <strong>SemanticKernelService.cs</strong> file. The system prompt instructs the LLM how to respond and allows developers to guide the model depending on their use case.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex34"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex34"><span></span></label> Directly below the system message you added, add a <strong>foreach</strong> loop to prepare messages from the user to be sent to the LLM. </p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> message </span><span class="kwd">in</span><span class="pln"> contextWindow</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    skChatHistory</span><span class="pun">.</span><span class="typ">AddUserMessage</span><span class="pun">(</span><span class="pln">message</span><span class="pun">.</span><span class="typ">Prompt</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">message</span><span class="pun">.</span><span class="typ">Completion</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">string</span><span class="pun">.</span><span class="typ">Empty</span><span class="pun">)</span><span class="pln">
        skChatHistory</span><span class="pun">.</span><span class="typ">AddAssistantMessage</span><span class="pun">(</span><span class="pln">message</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">);</span><span class="pln">
</span><span class="pun">}</span></code></pre>
<p>
<img src="./z0fou4a5.jpg" alt="z0fou4a5.jpg"></p>
<blockquote class="note">
  <p>You'll get to know why this is a <strong>List</strong> object in a future task. At this point, it only contains a single user prompt.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex35"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex35"><span></span></label> Replace the next 3 lines of code (<strong>string</strong>, <strong>int</strong>, and <strong>await</strong>), below the foreach loop, with the following:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//string completion = "Place holder response";</span><span class="pln">
</span><span class="com">//int tokens = 0;</span><span class="pln">
</span><span class="com">//await Task.Delay(0);</span><span class="pln">

</span><span class="typ">PromptExecutionSettings</span><span class="pln"> settings </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="typ">ExtensionData</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Dictionary</span><span class="pun">&lt;</span><span class="kwd">string</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">object</span><span class="pun">&gt;()</span><span class="pln">
    </span><span class="pun">{</span><span class="pln">
        </span><span class="pun">{</span><span class="pln"> </span><span class="str">"temperature"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.2</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
        </span><span class="pun">{</span><span class="pln"> </span><span class="str">"top_p"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.7</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
        </span><span class="pun">{</span><span class="pln"> </span><span class="str">"max_tokens"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1000</span><span class="pln">  </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="pun">};</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> result </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> kernel</span><span class="pun">.</span><span class="typ">GetRequiredService</span><span class="pun">&lt;</span><span class="typ">IChatCompletionService</span><span class="pun">&gt;().</span><span class="typ">GetChatMessageContentAsync</span><span class="pun">(</span><span class="pln">skChatHistory</span><span class="pun">,</span><span class="pln"> settings</span><span class="pun">);</span><span class="pln">

</span><span class="typ">ChatTokenUsage</span><span class="pln"> completionUsage </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ChatTokenUsage</span><span class="pun">)</span><span class="pln">result</span><span class="pun">.</span><span class="typ">Metadata</span><span class="pun">![</span><span class="str">"Usage"</span><span class="pun">]!;</span><span class="pln">

</span><span class="kwd">string</span><span class="pln"> completion </span><span class="pun">=</span><span class="pln"> result</span><span class="pun">.</span><span class="typ">Items</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="typ">ToString</span><span class="pun">()!;</span><span class="pln">
</span><span class="kwd">int</span><span class="pln"> tokens </span><span class="pun">=</span><span class="pln"> completionUsage</span><span class="pun">.</span><span class="typ">OutputTokenCount</span><span class="pun">;</span></code></pre>
<p>
<img src="./h6a2xwm2.jpg" alt="h6a2xwm2.jpg"></p>
<blockquote class="note">
  <p>This executes the call to Azure OpenAI using the Semantic Kernel extension configured earlier. You'll get the completion text and tokens consumed to return to the user. </p>
</blockquote></li>
<li class="task-list-item" id="taskIndex36"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex36"><span></span></label> You'll also use the chat completion extension to generate a summary of the chat to display in the UI. In the same file, find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">SummarizeConversationAsync</span></code>() method. </p></li>
<li class="task-list-item" id="taskIndex37"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex37"><span></span></label> In the method, above the existing <strong>return</strong> statement, replace the 2 lines of code (<strong>await</strong>, <strong>string</strong>) with the following:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//await Task.Delay(0);</span><span class="pln">
</span><span class="com">//string completion = "Placeholder summary";</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> skChatHistory </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ChatHistory</span><span class="pun">();</span><span class="pln">
skChatHistory</span><span class="pun">.</span><span class="typ">AddSystemMessage</span><span class="pun">(</span><span class="pln">_summarizePrompt</span><span class="pun">);</span><span class="pln">
skChatHistory</span><span class="pun">.</span><span class="typ">AddUserMessage</span><span class="pun">(</span><span class="pln">conversation</span><span class="pun">);</span><span class="pln">

</span><span class="typ">PromptExecutionSettings</span><span class="pln"> settings </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="typ">ExtensionData</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Dictionary</span><span class="pun">&lt;</span><span class="kwd">string</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">object</span><span class="pun">&gt;()</span><span class="pln">
    </span><span class="pun">{</span><span class="pln">
        </span><span class="pun">{</span><span class="pln"> </span><span class="str">"temperature"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.0</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
        </span><span class="pun">{</span><span class="pln"> </span><span class="str">"top_p"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.0</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
        </span><span class="pun">{</span><span class="pln"> </span><span class="str">"max_tokens"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">100</span><span class="pln"> </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="pun">};</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> result </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> kernel</span><span class="pun">.</span><span class="typ">GetRequiredService</span><span class="pun">&lt;</span><span class="typ">IChatCompletionService</span><span class="pun">&gt;().</span><span class="typ">GetChatMessageContentAsync</span><span class="pun">(</span><span class="pln">skChatHistory</span><span class="pun">,</span><span class="pln"> settings</span><span class="pun">);</span><span class="pln">

</span><span class="kwd">string</span><span class="pln"> completion </span><span class="pun">=</span><span class="pln"> result</span><span class="pun">.</span><span class="typ">Items</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="typ">ToString</span><span class="pun">()!;</span></code></pre>
<p>
<img src="./h6ta7gpo.jpg" alt="h6ta7gpo.jpg"></p>
<blockquote class="knowledge">
  <p>This code has a similar flow for generating a completion using the Semantic Kernel OpenAI chat completion extension, however, notice the system prompt you're passing in is different. The <strong>_summarizePrompt</strong> instructs the model to provide a short summary that we'll use to name the chat.</p>
</blockquote><div class="moreKnowledge"><a href="https://labclient.labondemand.com/Instructions/e013c27b-7e28-4b7b-a514-ffe8a76c35a1#" class="moreKnowledgeLink">more...</a></div></li>
<li class="task-list-item" id="taskIndex38"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex38"><span></span></label> Save the file by selecting <strong>File</strong> in the upper left of the window, then select <strong>Save</strong>.</p></li>
</ol>
</div><div class="page" id="page8">
<h2 id="03-implement-the-semantic-kernel-service">03: Implement the Semantic Kernel service</h2>
<p>To keep things organized, you'll create a dedicated service that handles AI logic. CWBC aims for a maintainable system-when future updates roll in (like advanced route-finding), they can simply plug into this well-structured AI layer.</p>
<p>You now need to take our completed Semantic Kernel service and use it in the <strong>ChatService.cs</strong> for our lab.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex39"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex39"><span></span></label> In VS Code's <strong>EXPLORER</strong> pane, select <strong>ChatService.cs</strong> under the same <strong>Services</strong> subfolder.</p>
<p>
<img src="./h4471tn7.jpg" alt="h4471tn7.jpg"></p></li>
<li class="task-list-item" id="taskIndex40"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex40"><span></span></label> Select <strong>Ctrl+F</strong> to find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">GetChatCompletionAsync</span></code>() function. </p>
<blockquote class="note">
  <p>You need to modify this function to use our new Semantic Kernel implementation. </p>
</blockquote></li>
<li class="task-list-item" id="taskIndex41"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex41"><span></span></label> Replace the 2 placeholder <strong>chatMessage</strong> lines, adding lines to create a list of messages from the user prompt and call our Semantic Kernel service, using the following:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//chatMessage.Completion = "Place holder response";</span><span class="pln">
</span><span class="com">//chatMessage.CompletionTokens = 0;</span><span class="pln">

</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> messages </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> chatMessage </span><span class="pun">};</span><span class="pln">
</span><span class="pun">(</span><span class="pln">chatMessage</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">CompletionTokens</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">GetChatCompletionAsync</span><span class="pun">(</span><span class="pln">messages</span><span class="pun">);</span></code></pre>
<p>
<img src="./30hwamwq.jpg" alt="30hwamwq.jpg"></p></li>
<li class="task-list-item" id="taskIndex42"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex42"><span></span></label> Save the <strong>ChatService.cs</strong> file.</p></li>
</ol>
</div><div class="page" id="page9">
<h2 id="04-check-your-work">04: Check your work</h2>
<p>Time for a quick spin around the block. Run the application, ask a simple question (like "<strong>What are the most expensive bikes?</strong>"), and see if the assistant replies with more than a placeholder. A successful test ensures the AI engine is functioning correctly.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex43"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex43"><span></span></label> In the VS Code terminal, start the application again.</p>
<pre><div class="codeTitle"><span class="title">bash</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="bash language-bash prettyprint prettyprinted" tabindex="0" style=""><span class="pln">cd </span><span class="pun">~/</span><span class="typ">Repos</span><span class="pun">/</span><span class="pln">cosmosdb</span><span class="pun">-</span><span class="pln">nosql</span><span class="pun">-</span><span class="pln">copilot</span><span class="pun">/</span><span class="pln">src</span><span class="pun">/</span><span class="pln">cosmos</span><span class="pun">-</span><span class="pln">copilot</span><span class="pun">.</span><span class="typ">AppHost</span><span class="pln">
dotnet run</span></code></pre></li>
<li class="task-list-item" id="taskIndex44"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex44"><span></span></label> Select <strong>Ctrl+click</strong> on the URL on the <strong>Login to the dashboard</strong> line again to open the .NET Aspire dashboard. </p>
<p>
<img src="./qzzrpnbe.jpg" alt="qzzrpnbe.jpg"></p></li>
<li class="task-list-item" id="taskIndex45"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex45"><span></span></label> Select the <strong>http://localhost:8100</strong> endpoint to launch the chat application.</p></li>
<li class="task-list-item" id="taskIndex46"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex46"><span></span></label> In the leftmost pane, select <strong>Create New Chat</strong>, then select the <strong>New Chat</strong> tile.</p></li>
<li class="task-list-item" id="taskIndex47"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex47"><span></span></label> Enter <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> are the most expensive bikes</span><span class="pun">?</span></code> </p>
<blockquote class="note">
  <p>You should see similar output, but don't worry if it's not identical.</p>
  <p>
  <img src="./pmo2g8bw.jpg" alt="pmo2g8bw.jpg"></p>
</blockquote></li>
<li class="task-list-item" id="taskIndex48"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex48"><span></span></label> Keep the application running, as you'll use this same session in the next task.</p></li>
</ol>
<p></p><details>
    <summary>Is your application not working or throwing exceptions? Select this to compare your code against this example.</summary><p></p>
<p><br></p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex49"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex49"><span></span></label> Review the <strong>GetChatCompletionAsync()</strong> function in the <strong>SemanticKernelService.cs</strong> to make sure that your code matches this sample.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;(</span><span class="kwd">string</span><span class="pln"> completion</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> tokens</span><span class="pun">)&gt;</span><span class="pln"> </span><span class="typ">GetChatCompletionAsync</span><span class="pun">(</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> contextWindow</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> skChatHistory </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ChatHistory</span><span class="pun">();</span><span class="pln">
    skChatHistory</span><span class="pun">.</span><span class="typ">AddSystemMessage</span><span class="pun">(</span><span class="pln">_systemPrompt</span><span class="pun">);</span><span class="pln">

    </span><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> message </span><span class="kwd">in</span><span class="pln"> contextWindow</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">{</span><span class="pln">
       skChatHistory</span><span class="pun">.</span><span class="typ">AddUserMessage</span><span class="pun">(</span><span class="pln">message</span><span class="pun">.</span><span class="typ">Prompt</span><span class="pun">);</span><span class="pln">
       </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">message</span><span class="pun">.</span><span class="typ">Completion</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">string</span><span class="pun">.</span><span class="typ">Empty</span><span class="pun">)</span><span class="pln">
           skChatHistory</span><span class="pun">.</span><span class="typ">AddAssistantMessage</span><span class="pun">(</span><span class="pln">message</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="typ">PromptExecutionSettings</span><span class="pln"> settings </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">{</span><span class="pln">
       </span><span class="typ">ExtensionData</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Dictionary</span><span class="pun">&lt;</span><span class="kwd">string</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">object</span><span class="pun">&gt;()</span><span class="pln">
       </span><span class="pun">{</span><span class="pln">
           </span><span class="pun">{</span><span class="pln"> </span><span class="str">"temperature"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.2</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
           </span><span class="pun">{</span><span class="pln"> </span><span class="str">"top_p"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.7</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
           </span><span class="pun">{</span><span class="pln"> </span><span class="str">"max_tokens"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1000</span><span class="pln">  </span><span class="pun">}</span><span class="pln">
       </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">};</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> result </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> kernel</span><span class="pun">.</span><span class="typ">GetRequiredService</span><span class="pun">&lt;</span><span class="typ">IChatCompletionService</span><span class="pun">&gt;().</span><span class="typ">GetChatMessageContentAsync</span><span class="pun">(</span><span class="pln">skChatHistory</span><span class="pun">,</span><span class="pln"> settings</span><span class="pun">);</span><span class="pln">

    </span><span class="typ">ChatTokenUsage</span><span class="pln"> completionUsage </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ChatTokenUsage</span><span class="pun">)</span><span class="pln">result</span><span class="pun">.</span><span class="typ">Metadata</span><span class="pun">![</span><span class="str">"Usage"</span><span class="pun">]!;</span><span class="pln">

    </span><span class="kwd">string</span><span class="pln"> completion </span><span class="pun">=</span><span class="pln"> result</span><span class="pun">.</span><span class="typ">Items</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="typ">ToString</span><span class="pun">()!;</span><span class="pln">
    </span><span class="kwd">int</span><span class="pln"> tokens </span><span class="pun">=</span><span class="pln"> completionUsage</span><span class="pun">.</span><span class="typ">OutputTokenCount</span><span class="pun">;</span><span class="pln">

    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">completion</span><span class="pun">,</span><span class="pln"> tokens</span><span class="pun">);</span><span class="pln">
</span><span class="pun">}</span></code></pre></li>
<li class="task-list-item" id="taskIndex50"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex50"><span></span></label> Review the <strong>SummarizeConversationAsync()</strong> function in the <strong>SemanticKernelService.cs</strong> to make sure that your code matches this sample.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="str">&lt;string&gt;</span><span class="pln"> </span><span class="typ">SummarizeConversationAsync</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> conversation</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> skChatHistory </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ChatHistory</span><span class="pun">();</span><span class="pln">
    skChatHistory</span><span class="pun">.</span><span class="typ">AddSystemMessage</span><span class="pun">(</span><span class="pln">_summarizePrompt</span><span class="pun">);</span><span class="pln">
    skChatHistory</span><span class="pun">.</span><span class="typ">AddUserMessage</span><span class="pun">(</span><span class="pln">conversation</span><span class="pun">);</span><span class="pln">

    </span><span class="typ">PromptExecutionSettings</span><span class="pln"> settings </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">{</span><span class="pln">
        </span><span class="typ">ExtensionData</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Dictionary</span><span class="pun">&lt;</span><span class="kwd">string</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">object</span><span class="pun">&gt;()</span><span class="pln">
        </span><span class="pun">{</span><span class="pln">
            </span><span class="pun">{</span><span class="pln"> </span><span class="str">"temperature"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.0</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
            </span><span class="pun">{</span><span class="pln"> </span><span class="str">"top_p"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1.0</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
            </span><span class="pun">{</span><span class="pln"> </span><span class="str">"max_tokens"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">100</span><span class="pln"> </span><span class="pun">}</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">};</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> result </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> kernel</span><span class="pun">.</span><span class="typ">GetRequiredService</span><span class="pun">&lt;</span><span class="typ">IChatCompletionService</span><span class="pun">&gt;().</span><span class="typ">GetChatMessageContentAsync</span><span class="pun">(</span><span class="pln">skChatHistory</span><span class="pun">,</span><span class="pln"> settings</span><span class="pun">);</span><span class="pln">

    </span><span class="kwd">string</span><span class="pln"> completion </span><span class="pun">=</span><span class="pln"> result</span><span class="pun">.</span><span class="typ">Items</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="typ">ToString</span><span class="pun">()!;</span><span class="pln">

    </span><span class="kwd">return</span><span class="pln"> completion</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span></code></pre>
<p></p></li></ol></details><p></p>

<hr>
<p><strong>Congratulations!</strong> You've successfully completed this task.</p>
</div><div class="page" id="page10">
<h1 id="task-03-implement-chat-history-context-window">Task 03: Implement Chat History (Context Window)</h1>
<h2 id="introduction-2">Introduction</h2>
<p>A big objective for Boulder is creating a "conversational infotainment system". That means remembering prior user inputs, like recent route selections, so follow-up queries feel natural. Customers rarely ask just one question. A rider might ask about "e-bikes for commuting," then follow up with "Which has the longest battery range?". For the conversation to feel seamless, your Intelligent Assistant must remember what the user already asked. This is where your context window comes in, like building a memory into the bike's onboard computer.</p>
<h2 id="description-2">Description</h2>
<p>You have the basics for your generative AI application now in place. Next, you'll do further testing and explore how well it responds to natural language interactions.</p>
<h2 id="success-criteria-2">Success criteria</h2>
<ul>
<li>Your Intelligent Assistant "remembers" previous user prompts, enabling follow-up questions to reference earlier context.</li>
<li>You have logic in place to ensure the AI doesn't exceed token limits or slow down.</li>
<li>When you ask a second question, the answer reflects details from your first question, proving context is working.</li>
</ul>
<h2 id="learning-resources-2">Learning resources</h2>
<ul>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/azure/ai-services/openai/concepts/models" target="_blank" aria-label="(opens a new window)">Understanding Token Usage in LLMs</a>  </li>
</ul>
</div><div class="page" id="page11">
<h2 id="01-test-contextual-follow-up-questions">01: Test contextual follow-up questions</h2>
<p>Before adding chat history, a second question won't reference the first, leaving the user confused. Seeing that failure helps you appreciate why CWBC insisted on multi-turn conversations-no one wants to repeat themselves.</p>
<p>Let's explore what happens when you test contextual follow-up questions with our LLM by asking follow-up questions that imply an existing context, like you would have in a conversation with another person.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex51"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex51"><span></span></label> In the same chat session as the previous task, enter: <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> are the least expensive</span><span class="pun">?</span></code></p>
<blockquote class="note">
  <p>The response generated will either have nothing to do with your first question, or the LLM may respond that it needs more context to give you an answer.</p>
  <p>This demonstrates that LLM's are stateless. They don't maintain any conversation history by themselves and are missing the context necessary for the LLM to respond appropriately to your second question.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex52"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex52"><span></span></label> Close the web browser and end the process in the terminal by selecting <strong>Ctrl+C</strong>.</p></li>
</ol>
</div><div class="page" id="page12">
<h3 id="tokens-in-large-language-models">Tokens in Large Language Models</h3>
<p>In this task, you'll implement chat history, often called a <strong>Context Window</strong> for a generative AI application. Before you write the code, we need to explain the concept of tokens for an LLM and why these are important to consider when implementing a context window.</p>
<p>LLMs require chat history to generate contextually relevant results, but they have limits on how much text they can process in a request, and output in a response. These limits are not expressed as words, but as <strong>tokens</strong>. Tokens represent words or part of a word. On average 4 characters is one token. Tokens are essentially the compute currency for a large language model.</p>
<p>It's necessary to manage the usage of tokens within your app to stay within the LLM's limits. This can be a bit tricky in certain scenarios. You need to provide enough context for the LLM to generate a correct response, while avoiding negative results of consuming too many tokens such as getting incomplete results or unexpected behavior.</p>
<p>To limit the maximum amount of chat history (and text) we send to our LLM, we'll count the number of user prompts we send to the LLM as context. This app uses a variable <strong>_maxContextWindow</strong> to manage the limit for each request.</p>
</div><div class="page" id="page13">
<h2 id="02-building-a-context-window-using-tokens">02: Building a context window using tokens</h2>
<p>You'll store recent messages but also mind the token limit. CWBC can't afford slow, bloated requests. Striking a balance ensures your Intelligent Assistant remembers enough about the conversation without bogging down performance.</p>
<p>In this task, you'll implement the <strong>GetSessionContextWindowAsync()</strong> function in the <strong>Services/CosmosDbService.cs</strong> class to build our chat history.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex53"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex53"><span></span></label> In VS Code's <strong>EXPLORER</strong> pane, open <strong>CosmosDbService.cs</strong> from the same <strong>Services</strong> subfolder as the previous files you modified.</p>
<p>
<img src="./arj35xmd.jpg" alt="arj35xmd.jpg"></p></li>
<li class="task-list-item" id="taskIndex54"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex54"><span></span></label> Select <strong>Ctrl+F</strong> to find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">GetSessionContextWindowAsync</span></code>() method with the following signature:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;&gt;</span><span class="pln"> </span><span class="typ">GetSessionContextWindowAsync</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> tenantId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> maxContextWindow</span><span class="pun">)</span></code></pre></li>
<li class="task-list-item" id="taskIndex55"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex55"><span></span></label> Replace the placeholder <strong>string queryText</strong> in this function and add a query, using the following:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//string queryText = $"";</span><span class="pln">
</span><span class="kwd">string</span><span class="pln"> queryText </span><span class="pun">=</span><span class="pln"> $</span><span class="str">"""
    SELECT Top @maxContextWindow
        *
    FROM c  
    WHERE 
        c.tenantId = @tenantId AND 
        c.userId = @userId AND
        c.sessionId = @sessionId AND 
        c.type = @type
    ORDER BY 
        c.timeStamp DESC
    """</span><span class="pun">;</span></code></pre>
<p>
<img src="./ymdesz8a.jpg" alt="ymdesz8a.jpg"></p>
<blockquote class="note">
  <p>This selects the most recent number of messages in the chat session depending on the <strong>maxContextWindow</strong> variable.</p>
  <p>After querying for the most recent messages in Azure Cosmos DB, we put them back in order in reverse. The most recent text is what we want closer to the actual question. Counting the number of messages allows us to control the total number of tokens used while still providing relevant context.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex56"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex56"><span></span></label> Save the <strong>CosmosDbService.cs</strong> file.</p></li>
<li class="task-list-item" id="taskIndex57"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex57"><span></span></label> Go back to the <strong>ChatService.cs</strong> file.</p></li>
<li class="task-list-item" id="taskIndex58"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex58"><span></span></label> Find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> </span><span class="typ">GetChatCompletionAsync</span></code> line. </p></li>
<li class="task-list-item" id="taskIndex59"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex59"><span></span></label> Use the following to replace the two lines initializing the <strong>List<message> messages</message></strong> variable and passing it to the Semantic Kernel service:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//List&lt;Message&gt; messages = new List&lt;Message&gt;() { chatMessage };</span><span class="pln">
</span><span class="com">//(chatMessage.Completion, chatMessage.CompletionTokens) = await _semanticKernelService.GetChatCompletionAsync(messages);</span><span class="pln">

</span><span class="com">//Get the context window for this conversation up to the maximum conversation depth.</span><span class="pln">
</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> contextWindow </span><span class="pun">=</span><span class="pln"> 
    </span><span class="kwd">await</span><span class="pln"> _cosmosDbService</span><span class="pun">.</span><span class="typ">GetSessionContextWindowAsync</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> _maxContextWindow</span><span class="pun">);</span><span class="pln">

</span><span class="pun">(</span><span class="pln">chatMessage</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">CompletionTokens</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">GetChatCompletionAsync</span><span class="pun">(</span><span class="pln">contextWindow</span><span class="pun">);</span></code></pre>
<p>
<img src="./zsfgfi6v.jpg" alt="zsfgfi6v.jpg"></p>
<blockquote class="note">
  <p>This calls the function to get the context window that you just updated, and passes the context window to the Semantic Kernel Service to get a completion from Azure OpenAI.</p>
  <p>You're now passing in a list of messages that represents the conversation history to get our contextually relevant completion. You implemented <strong>GetChatCompletionAsync()</strong> to take a list of prompts, rather than a single prompt representing the current user message alone.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex60"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex60"><span></span></label> Save the <strong>ChatService.cs</strong> file.</p></li>
</ol>
</div><div class="page" id="page14">
<h2 id="03-check-your-work">03: Check your work</h2>
<p>A test ride with two or three related questions reveals whether the system can keep track. If it references the first question when answering the second, you know chat history is working-just as CWBC envisioned for a smooth user experience.</p>
<p>You're now ready to test your context window implementation.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex61"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex61"><span></span></label> In the VS Code terminal, start the application:</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">dotnet run</span></code></p></li>
<li class="task-list-item" id="taskIndex62"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex62"><span></span></label> <strong>Ctrl+click</strong> the URL on the <strong>Login to the dashboard</strong> line.</p></li>
<li class="task-list-item" id="taskIndex63"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex63"><span></span></label> Select the <strong>http://localhost:8100</strong> endpoint to start the chat application.</p></li>
<li class="task-list-item" id="taskIndex64"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex64"><span></span></label> Select <strong>Create New Chat</strong> on the left, then select the <strong>New Chat</strong> tile that was created.</p>
<p>
<img src="./9n2fevru.jpg" alt="9n2fevru.jpg"></p></li>
<li class="task-list-item" id="taskIndex65"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex65"><span></span></label> Enter <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> are the most expensive bikes</span><span class="pun">?</span></code></p></li>
<li class="task-list-item" id="taskIndex66"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex66"><span></span></label> Enter <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> are the least expensive</span><span class="pun">?</span></code> as a follow-up.</p>
<blockquote class="note">
  <p>You should now see appropriate output similar to the following.</p>
</blockquote>
<p>
<img src="./j4yt3rxp.jpg" alt="j4yt3rxp.jpg"></p></li>
<li class="task-list-item" id="taskIndex67"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex67"><span></span></label> Close the browser.</p></li>
<li class="task-list-item" id="taskIndex68"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex68"><span></span></label> End the process in the terminal by selecting <strong>Ctrl+C</strong>.</p></li>
</ol>
<p></p><details>
    <summary>Is your application not working or throwing exceptions? Select here to compare your code against this example.</summary><p></p>
<p><br></p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex69"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex69"><span></span></label> Review the <strong>GetChatCompletionAsync</strong> method of the <strong>ChatService.cs</strong> code file to make sure that your code matches this sample.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> </span><span class="typ">GetChatCompletionAsync</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> tenantId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> promptText</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
   </span><span class="com">//Create a message object for the new user prompt and calculate the tokens for the prompt</span><span class="pln">
    </span><span class="typ">Message</span><span class="pln"> chatMessage </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> </span><span class="typ">CreateChatMessageAsync</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> promptText</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Get the context window for this conversation up to the maximum conversation depth.</span><span class="pln">
    </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> contextWindow </span><span class="pun">=</span><span class="pln"> 
        </span><span class="kwd">await</span><span class="pln"> _cosmosDbService</span><span class="pun">.</span><span class="typ">GetSessionContextWindowAsync</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> _maxContextWindow</span><span class="pun">);</span><span class="pln">

    </span><span class="pun">(</span><span class="pln">chatMessage</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">CompletionTokens</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">GetChatCompletionAsync</span><span class="pun">(</span><span class="pln">sessionId</span><span class="pun">,</span><span class="pln"> contextWindow</span><span class="pun">);</span><span class="pln">

    </span><span class="kwd">await</span><span class="pln"> </span><span class="typ">UpdateSessionAndMessage</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">);</span><span class="pln">

    </span><span class="kwd">return</span><span class="pln"> chatMessage</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span></code></pre>
<p></p></li></ol></details><p></p>

<hr>
<p><strong>Congratulations!</strong> You've successfully completed this task.</p>
</div><div class="page" id="page15">
<h1 id="task-04-implement-the-rag-pattern">Task 04: Implement the RAG Pattern</h1>
<h2 id="introduction-3">Introduction</h2>
<p>CWBC needs accurate answers rooted in actual product data like real bike specs, e-bike battery details, or recommended routes. This is where Retrieval Augmented Generation (RAG) comes in. By pulling relevant documents from Azure Cosmos DB first, you prevent the AI from "hallucinating." It's like verifying each part of the bike is genuine before selling it. RAG is a fancy way of saying that the LLM will generate a completion using data retrieved elsewhere. The source of this data can be anything including files or data from a database. Typically, the data is the result of a search for semantically relevant results to what the user is asking for. This often involves the use of a vector search against a database. The results of that search are passed with the context window and user prompt to then generate a response. </p>
<h2 id="description-3">Description</h2>
<p>In this task, you'll use the RAG pattern to search for relevant products in your Azure Cosmos DB database, instead of having the model return general answers from the LLM. Here, RAG pattern ensures that the chat application you're building for your catalog gives users answers about available products or routes. These contextual answers are much more relevant to your application and demonstrate the power of RAG for building your own generative AI apps. </p>
<p>The workflow for RAG Pattern generally maps to the following steps:</p>
<ol>
<li>User types in a user prompt or question.</li>
<li>The user prompt is vectorized by an embeddings model and returned as an array of vectors.</li>
<li>These vectors are used in a vector search against a database. Results are returned ordered by semantic similarity.</li>
<li>The search results, the context window (chat history), and the latest user prompt are sent to the LLM.</li>
<li>The LLM processes all the text in the payload and generates a response.</li>
</ol>
<h2 id="success-criteria-3">Success criteria</h2>
<ul>
<li>When you asked a question, vector embeddings were created to represent your query.</li>
<li>Your query triggered a vector search in Azure Cosmos DB and found the matching product or route information.</li>
<li>Your AI successfully referenced real Cosmic Works data and avoided the invention of details.</li>
<li>Your entire pipeline, from creating embeddings to searching and generating the final AI response, operated smoothly without crashes or producing "hallucinated" data.</li>
</ul>
<h2 id="learning-resources-3">Learning resources</h2>
<ul>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/azure/cosmos-db/gen-ai/rag" target="_blank" aria-label="(opens a new window)">Retrieval Augmented Generation in Azure Cosmos DB</a></li>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/azure/cosmos-db/gen-ai/vector-search-overview" target="_blank" aria-label="(opens a new window)">Vector search in Azure Cosmos DB</a> </li>
</ul>
</div><div class="page" id="page16">
<h2 id="01-generate-embeddings-from-the-user-prompt">01: Generate embeddings from the user prompt</h2>
<p>Turning user text into vector embeddings unlocks the power to find matching info in your data. CWBC is excited about the idea that "Which bikes have the best battery range?" triggers a search for actual e-bike models in your database.</p>
<p>You'll first need to add the OpenAI embeddings generation extension to the Semantic Kernel service.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex70"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex70"><span></span></label> Go to the <strong>SemanticKernelService.cs</strong> file you modified previously in the <strong>Services</strong> subfolder.</p></li>
<li class="task-list-item" id="taskIndex71"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex71"><span></span></label> Find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="typ">SemanticKernelService</span></code>() constructor with the following signature:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="typ">SemanticKernelService</span><span class="pun">(</span><span class="typ">OpenAIClient</span><span class="pln"> openAiClient</span><span class="pun">,</span><span class="pln"> </span><span class="typ">CosmosClient</span><span class="pln"> cosmosClient</span><span class="pun">,</span><span class="pln"> </span><span class="typ">IOptions</span><span class="pun">&lt;</span><span class="typ">OpenAi</span><span class="pun">&gt;</span><span class="pln"> openAIOptions</span><span class="pun">,</span><span class="pln"> </span><span class="typ">IOptions</span><span class="pun">&lt;</span><span class="typ">CosmosDb</span><span class="pun">&gt;</span><span class="pln"> cosmosOptions</span><span class="pun">)</span></code></pre></li>
<li class="task-list-item" id="taskIndex72"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex72"><span></span></label> You added the OpenAI chat completion extension in the previous task. Find the line for <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">builder</span><span class="pun">.</span><span class="typ">AddOpenAIChatCompletion</span></code>.</p>
<p>Below that line, add the extension for OpenAI embedding generation.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//Add Azure OpenAI text embedding generation service</span><span class="pln">
builder</span><span class="pun">.</span><span class="typ">AddOpenAITextEmbeddingGeneration</span><span class="pun">(</span><span class="pln">modelId</span><span class="pun">:</span><span class="pln"> embeddingDeploymentName</span><span class="pun">,</span><span class="pln"> openAIClient</span><span class="pun">:</span><span class="pln"> openAiClient</span><span class="pun">,</span><span class="pln"> dimensions</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1536</span><span class="pun">);</span></code></pre>
<p>
<img src="./f5nwur5d.jpg" alt="f5nwur5d.jpg"></p></li>
<li class="task-list-item" id="taskIndex73"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex73"><span></span></label> Find <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">GetEmbeddingsAsync</span></code>(). </p></li>
<li class="task-list-item" id="taskIndex74"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex74"><span></span></label> Replace the two lines (<strong>await</strong>, <strong>float</strong>) above the <strong>return</strong> statement, using the following: </p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//await Task.Delay(0);</span><span class="pln">
</span><span class="com">//float[] embeddingsArray = new float[0];</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> embeddings </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> kernel</span><span class="pun">.</span><span class="typ">GetRequiredService</span><span class="pun">&lt;</span><span class="typ">ITextEmbeddingGenerationService</span><span class="pun">&gt;().</span><span class="typ">GenerateEmbeddingAsync</span><span class="pun">(</span><span class="pln">text</span><span class="pun">);</span><span class="pln">
</span><span class="kwd">float</span><span class="pun">[]</span><span class="pln"> embeddingsArray </span><span class="pun">=</span><span class="pln"> embeddings</span><span class="pun">.</span><span class="typ">ToArray</span><span class="pun">();</span></code></pre>
<p>
<img src="./g03eaek4.jpg" alt="g03eaek4.jpg"></p>
<blockquote class="note">
  <p>The new code here uses the built-in embedding service to generate vectors out of the user text. It then converts the result to an array of floats.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex75"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex75"><span></span></label> Save <strong>SemanticKernelService.cs</strong>.</p></li>
<li class="task-list-item" id="taskIndex76"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex76"><span></span></label> In the terminal, ensure the code compiles:</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">dotnet build</span></code></p>
<blockquote class="note">
  <p>The warnings are safe to ignore.</p>
</blockquote>
<p>
<img src="./s17d6sz4.jpg" alt="s17d6sz4.jpg"></p></li>
<li class="task-list-item" id="taskIndex77"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex77"><span></span></label> If the code compiles with no errors, move on to the next step.</p></li>
</ol>
<p></p><details>
    <summary>Is your application not working or throwing exceptions? Select here to compare your code against this example.</summary><p></p>
<p><br></p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex78"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex78"><span></span></label> Review the <strong>SemanticKernelService()</strong> constructor in <strong>SemanticKernelService.cs</strong> to make sure that your code matches this sample.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="typ">SemanticKernelService</span><span class="pun">(</span><span class="typ">OpenAIClient</span><span class="pln"> openAiClient</span><span class="pun">,</span><span class="pln"> </span><span class="typ">CosmosClient</span><span class="pln"> cosmosClient</span><span class="pun">,</span><span class="pln"> </span><span class="typ">IOptions</span><span class="pun">&lt;</span><span class="typ">OpenAi</span><span class="pun">&gt;</span><span class="pln"> openAIOptions</span><span class="pun">,</span><span class="pln"> </span><span class="typ">IOptions</span><span class="pun">&lt;</span><span class="typ">CosmosDb</span><span class="pun">&gt;</span><span class="pln"> cosmosOptions</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> completionDeploymentName </span><span class="pun">=</span><span class="pln"> openAIOptions</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">.</span><span class="typ">CompletionDeploymentName</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> embeddingDeploymentName </span><span class="pun">=</span><span class="pln"> openAIOptions</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">.</span><span class="typ">EmbeddingDeploymentName</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> maxRagTokens </span><span class="pun">=</span><span class="pln"> openAIOptions</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">.</span><span class="typ">MaxRagTokens</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> maxContextTokens </span><span class="pun">=</span><span class="pln"> openAIOptions</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">.</span><span class="typ">MaxContextTokens</span><span class="pun">;</span><span class="pln">

    </span><span class="kwd">var</span><span class="pln"> databaseName </span><span class="pun">=</span><span class="pln"> cosmosOptions</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">.</span><span class="typ">Database</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> productContainerName </span><span class="pun">=</span><span class="pln"> cosmosOptions</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">.</span><span class="typ">ProductContainer</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> productDataSourceURI </span><span class="pun">=</span><span class="pln"> cosmosOptions</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">.</span><span class="typ">ProductDataSourceURI</span><span class="pun">;</span><span class="pln">

    </span><span class="typ">ArgumentNullException</span><span class="pun">.</span><span class="typ">ThrowIfNullOrEmpty</span><span class="pun">(</span><span class="pln">completionDeploymentName</span><span class="pun">);</span><span class="pln">
    </span><span class="typ">ArgumentNullException</span><span class="pun">.</span><span class="typ">ThrowIfNullOrEmpty</span><span class="pun">(</span><span class="pln">embeddingDeploymentName</span><span class="pun">);</span><span class="pln">
    </span><span class="typ">ArgumentNullException</span><span class="pun">.</span><span class="typ">ThrowIfNullOrEmpty</span><span class="pun">(</span><span class="pln">maxRagTokens</span><span class="pun">);</span><span class="pln">
    </span><span class="typ">ArgumentNullException</span><span class="pun">.</span><span class="typ">ThrowIfNullOrEmpty</span><span class="pun">(</span><span class="pln">maxContextTokens</span><span class="pun">);</span><span class="pln">
    </span><span class="typ">ArgumentNullException</span><span class="pun">.</span><span class="typ">ThrowIfNullOrEmpty</span><span class="pun">(</span><span class="pln">databaseName</span><span class="pun">);</span><span class="pln">
    </span><span class="typ">ArgumentNullException</span><span class="pun">.</span><span class="typ">ThrowIfNullOrEmpty</span><span class="pun">(</span><span class="pln">productContainerName</span><span class="pun">);</span><span class="pln">
    </span><span class="typ">ArgumentNullException</span><span class="pun">.</span><span class="typ">ThrowIfNullOrEmpty</span><span class="pun">(</span><span class="pln">productDataSourceURI</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Set the product data source URI for loading data</span><span class="pln">
    _productDataSourceURI </span><span class="pun">=</span><span class="pln"> productDataSourceURI</span><span class="pun">;</span><span class="pln">

    </span><span class="com">// Initialize the Semantic Kernel</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> builder </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Kernel</span><span class="pun">.</span><span class="typ">CreateBuilder</span><span class="pun">();</span><span class="pln">

    </span><span class="com">//Add Azure OpenAI chat completion service</span><span class="pln">
    builder</span><span class="pun">.</span><span class="typ">AddOpenAIChatCompletion</span><span class="pun">(</span><span class="pln">modelId</span><span class="pun">:</span><span class="pln"> completionDeploymentName</span><span class="pun">,</span><span class="pln"> openAIClient</span><span class="pun">:</span><span class="pln"> openAiClient</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Add Azure OpenAI text embedding generation service</span><span class="pln">
    builder</span><span class="pun">.</span><span class="typ">AddOpenAITextEmbeddingGeneration</span><span class="pun">(</span><span class="pln">modelId</span><span class="pun">:</span><span class="pln"> embeddingDeploymentName</span><span class="pun">,</span><span class="pln"> openAIClient</span><span class="pun">:</span><span class="pln"> openAiClient</span><span class="pun">,</span><span class="pln"> dimensions</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1536</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Add Azure CosmosDB NoSql client and Database to the Semantic Kernel</span><span class="pln">
    builder</span><span class="pun">.</span><span class="typ">Services</span><span class="pun">.</span><span class="typ">AddSingleton</span><span class="pun">&lt;</span><span class="typ">Database</span><span class="pun">&gt;(</span><span class="pln">
        sp </span><span class="pun">=&gt;</span><span class="pln">
        </span><span class="pun">{</span><span class="pln">
            </span><span class="kwd">var</span><span class="pln"> client </span><span class="pun">=</span><span class="pln"> cosmosClient</span><span class="pun">;</span><span class="pln">
            </span><span class="kwd">return</span><span class="pln"> client</span><span class="pun">.</span><span class="typ">GetDatabase</span><span class="pun">(</span><span class="pln">databaseName</span><span class="pun">);</span><span class="pln">
        </span><span class="pun">});</span><span class="pln">

    </span><span class="com">// Add the Azure CosmosDB NoSQL Vector Store Record Collection for Products</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> options </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">AzureCosmosDBNoSQLVectorStoreRecordCollectionOptions</span><span class="pun">&lt;</span><span class="typ">Product</span><span class="pun">&gt;</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="typ">PartitionKeyPropertyName</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">"categoryId"</span><span class="pln"> </span><span class="pun">};</span><span class="pln">
    builder</span><span class="pun">.</span><span class="typ">AddAzureCosmosDBNoSQLVectorStoreRecordCollection</span><span class="pun">&lt;</span><span class="typ">Product</span><span class="pun">&gt;(</span><span class="pln">productContainerName</span><span class="pun">,</span><span class="pln"> options</span><span class="pun">);</span><span class="pln">

    kernel </span><span class="pun">=</span><span class="pln"> builder</span><span class="pun">.</span><span class="typ">Build</span><span class="pun">();</span><span class="pln">

   </span><span class="com">//Get a reference to the product container from Semantic Kernel for vector search and adding/updating products</span><span class="pln">
   _productContainer </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">AzureCosmosDBNoSQLVectorStoreRecordCollection</span><span class="pun">&lt;</span><span class="typ">Product</span><span class="pun">&gt;)</span><span class="pln">kernel</span><span class="pun">.</span><span class="typ">Services</span><span class="pun">.</span><span class="typ">GetRequiredService</span><span class="pun">&lt;</span><span class="typ">IVectorStoreRecordCollection</span><span class="pun">&lt;</span><span class="kwd">string</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Product</span><span class="pun">&gt;&gt;();</span><span class="pln">

    </span><span class="com">//Create a tokenizer for the model</span><span class="pln">
    _tokenizer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Tokenizer</span><span class="pun">.</span><span class="typ">CreateTiktokenForModel</span><span class="pun">(</span><span class="pln">modelName</span><span class="pun">:</span><span class="pln"> </span><span class="str">"gpt-4o"</span><span class="pun">);</span><span class="pln">
    _maxRagTokens </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Int32</span><span class="pun">.</span><span class="typ">TryParse</span><span class="pun">(</span><span class="pln">maxRagTokens</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">out</span><span class="pln"> _maxRagTokens</span><span class="pun">)</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> _maxRagTokens</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3000</span><span class="pun">;</span><span class="pln">
    _maxContextTokens </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Int32</span><span class="pun">.</span><span class="typ">TryParse</span><span class="pun">(</span><span class="pln">maxContextTokens</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">out</span><span class="pln"> _maxContextTokens</span><span class="pun">)</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> _maxContextTokens </span><span class="pun">:</span><span class="pln"> </span><span class="lit">1000</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span></code></pre></li>
<li class="task-list-item" id="taskIndex79"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex79"><span></span></label> Review the <strong>GetEmbeddingsAsync()</strong> function to make sure that your code matches this sample.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;</span><span class="kwd">float</span><span class="pun">[]&gt;</span><span class="pln"> </span><span class="typ">GetEmbeddingsAsync</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> text</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> embeddings </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> kernel</span><span class="pun">.</span><span class="typ">GetRequiredService</span><span class="pun">&lt;</span><span class="typ">ITextEmbeddingGenerationService</span><span class="pun">&gt;().</span><span class="typ">GenerateEmbeddingAsync</span><span class="pun">(</span><span class="pln">text</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">float</span><span class="pun">[]</span><span class="pln"> embeddingsArray </span><span class="pun">=</span><span class="pln"> embeddings</span><span class="pun">.</span><span class="typ">ToArray</span><span class="pun">();</span><span class="pln">

    </span><span class="kwd">return</span><span class="pln"> embeddingsArray</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span></code></pre>
<p></p></li></ol></details><p></p>

</div><div class="page" id="page17">
<h2 id="02-vector-search-on-user-data">02: Vector Search on user data</h2>
<p>With embeddings ready, you'll run a vector search on Cosmos DB to retrieve the best matches. Instead of rummaging randomly, the system quickly zeroes in on relevant products-key to giving riders meaningful advice.</p>
<p>The next step is to implement the vector search query in your application.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex80"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex80"><span></span></label> In <strong>SemanticKernelService.cs</strong> class, find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">SearchProductsAsync</span></code>() function with the following signature. </p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="str">&lt;string&gt;</span><span class="pln"> </span><span class="typ">SearchProductsAsync</span><span class="pun">(</span><span class="typ">ReadOnlyMemory</span><span class="str">&lt;float&gt;</span><span class="pln"> promptVectors</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> productMaxResults</span><span class="pun">)</span></code></pre></li>
<li class="task-list-item" id="taskIndex81"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex81"><span></span></label> Instead of writing a custom vector query to execute against our container, you can leverage Semantic Kernel's Azure Cosmos DB NoSQL Vector Store connector. This greatly reduces the amount of code you need to write to search our product data for relevant results. </p>
<p>Replace the two lines (<strong>string</strong>, <strong>await</strong>) above the <strong>return</strong> statement, using the following: </p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//string productsString = "";</span><span class="pln">
</span><span class="com">//await Task.Delay(0);</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> options </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">VectorSearchOptions</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="typ">VectorPropertyName</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">"vectors"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Top</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> productMaxResults </span><span class="pun">};</span><span class="pln">

</span><span class="com">//Call Semantic Kernel to perform the vector search</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> searchResult </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _productContainer</span><span class="pun">.</span><span class="typ">VectorizedSearchAsync</span><span class="pun">(</span><span class="pln">promptVectors</span><span class="pun">,</span><span class="pln"> options</span><span class="pun">);</span></code></pre>
<p>
<img src="./je4h9rg7.jpg" alt="je4h9rg7.jpg"></p>
<blockquote class="note">
  <p>This code uses the Semantic Kernel Azure Cosmos DB NoSQL Vector Store connector to:</p>
  <ol>
  <li>Indicate which property in the Azure Cosmos DB document contains the vectors to search against using <strong>VectorPropertyName</strong> in the <strong>VectorSearchOptions</strong>.</li>
  <li>Limit the number of products that are returned by the search using <strong>Top</strong>. Because LLM's can only process so much text at once, it's necessary to limit the amount of data returned by a vector search. The <strong>productMaxResults</strong> value limits that amount of data. This is something you may need to adjust when doing vector searches, so it's a config value in this application.</li>
  <li>Call the <strong>VectorizedSearchAsync()</strong> function in the Semantic Kernel connector. This performs vector search using the passed-in vector embeddings generated by the user prompt. The function automatically orders the results by the similarity score from most semantically relevant to least relevant.</li></ol>
</blockquote></li>
<li class="task-list-item" id="taskIndex82"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex82"><span></span></label> Below the block of code you added, add the following lines above the existing <strong>return</strong> statement:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">var</span><span class="pln"> resultRecords </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">VectorSearchResult</span><span class="pun">&lt;</span><span class="typ">Product</span><span class="pun">&gt;&gt;();</span><span class="pln">
</span><span class="kwd">await</span><span class="pln"> </span><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> result </span><span class="kwd">in</span><span class="pln"> searchResult</span><span class="pun">.</span><span class="typ">Results</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    resultRecords</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="pln">result</span><span class="pun">);</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">string</span><span class="pln"> productsString </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JsonSerializer</span><span class="pun">.</span><span class="typ">Serialize</span><span class="pun">(</span><span class="pln">resultRecords</span><span class="pun">);</span></code></pre>
<p>
<img src="./5xcvrojv.jpg" alt="5xcvrojv.jpg"></p>
<blockquote class="note">
  <p>This loops through the vector search results and serializes all products as a single string.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex83"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex83"><span></span></label> Save the <strong>SemanticKernelService.cs</strong> file.</p></li>
</ol>
</div><div class="page" id="page18">
<h2 id="03-system-prompts-and-generating-the-completion">03: System prompts and generating the completion</h2>
<p>Now that you have real product data, your system prompt must instruct the AI to stick to it. CWBC wants to avoid false answers. By feeding the retrieved data back into the AI, you ensure the final response is both conversational and true to the source.</p>
<p>You need to modify the LLM payload for generating the completion to include our new vector search results data. You also need to modify the system prompt you use to instruct the LLM how to generate the completion.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex84"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex84"><span></span></label> In the <strong>SemanticKernelService.cs</strong> class, find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">_systemPromptRetailAssistant</span></code> variable. </p></li>
<li class="task-list-item" id="taskIndex85"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex85"><span></span></label> Replace that line and add our new system prompt, using the following:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//private readonly string _systemPromptRetailAssistant = @"";</span><span class="pln">
</span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">readonly</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> _systemPromptRetailAssistant </span><span class="pun">=</span><span class="pln"> </span><span class="pun">@</span><span class="str">"
    You are an intelligent assistant for the Cosmic Works Bike Company. 
    You are designed to provide helpful answers to user questions about 
    bike products and accessories provided in JSON format below.

Instructions:
    - Only answer questions related to the information provided below.
    - Don't reference any product data not provided below.
    - If you're unsure of an answer, you can say ""I don't know"" or ""I'm not sure"" and recommend users search themselves.

Text of relevant information:"</span><span class="pun">;</span></code></pre>
<p>
<img src="./v7spo3so.jpg" alt="v7spo3so.jpg"></p>
<blockquote class="note">
  <p>Compare this system prompt to our original <strong>_systemPrompt</strong>. Both are similar in providing information for how the LLM should behave. However, the new prompt provides greater context and a clear list of instructions for what it's supposed to do. It also provides a placeholder for where the LLM expects to see additional information. </p>
</blockquote></li>
<li class="task-list-item" id="taskIndex86"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex86"><span></span></label> You next need to modify the function that will call the LLM. </p>
<p>Find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">GetRagCompletionAsync</span></code>() function in <strong>SemanticKernelService.cs</strong> with the following signature:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;(</span><span class="kwd">string</span><span class="pln"> completion</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> generationTokens</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> completionTokens</span><span class="pun">)&gt;</span><span class="pln"> </span><span class="typ">GetRagCompletionAsync</span><span class="pun">(</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> contextWindow</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> ragData</span><span class="pun">)</span></code></pre></li>
<li class="task-list-item" id="taskIndex87"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex87"><span></span></label> At the top of the function, add a new line to trim the incoming product search data based on the <strong>_maxRagTokens</strong> configuration. This uses a tokenizer from Semantic Kernel to help us control the number of tokens we're consuming for each request. </p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//Manage token consumption per request by trimming the amount of vector search data sent to the model</span><span class="pln">
ragData </span><span class="pun">=</span><span class="pln"> </span><span class="typ">TrimToTokenLimit</span><span class="pun">(</span><span class="pln">_maxRagTokens</span><span class="pun">,</span><span class="pln"> ragData</span><span class="pun">);</span></code></pre>
<p>
<img src="./cvb02vz5.jpg" alt="cvb02vz5.jpg"></p>
<blockquote class="note">
  <p>There are three parts to token control for this request:</p>
  <ul>
  <li><strong>_maxRagTokens</strong> limits the amount of product data we send to the model in our prompt. </li>
  <li><strong>_maxContextTokens</strong> controls how much text from our context window is passed as part of the prompt. Notice the foreach loop lower in this function that uses this variable to limit the number of prior messages added from our context window. </li>
  <li><strong>max_tokens</strong> in the <strong>PromptExecutionSettings</strong> limits the number of tokens the model uses to generate a response. </li></ul>
</blockquote>
<blockquote class="note">
  <p>The model we're using can consume a maximum of 4096 tokens per request. Our three settings help us ensure we're within the token consumption limits of our model on each request.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex88"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex88"><span></span></label> Below the <strong>ragData</strong> line you added, find the <strong>skChatHistory</strong> variable. </p></li>
<li class="task-list-item" id="taskIndex89"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex89"><span></span></label> Add a line below <strong>var skChatHistory</strong> to set the new system message:</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">skChatHistory</span><span class="pun">.</span><span class="typ">AddSystemMessage</span><span class="pun">(</span><span class="pln">_systemPromptRetailAssistant </span><span class="pun">+</span><span class="pln"> ragData</span><span class="pun">);</span></code></p>
<p>
<img src="./e2c1dms4.jpg" alt="e2c1dms4.jpg"></p>
<blockquote class="note">
  <p>This is where the vector search results are sent to the LLM and appended as part of the system prompt that you defined with the placeholder for additional information.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex90"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex90"><span></span></label> Save the <strong>SemanticKernelService.cs</strong> file.</p></li>
</ol>
</div><div class="page" id="page19">
<h2 id="04-putting-it-all-together">04: Putting it all together</h2>
<p>At this point, your Intelligent Assistant seamlessly merges user questions, vector search results, and GPT completions. CWBC can proudly say their customers get real-time answers grounded in official bike data.</p>
<p>The last step for our RAG Pattern implementation is to modify our LLM pipeline function in our application so that it generates embeddings from the user prompt, executes the vector search to find relevant products to those embeddings, and calls our new rag chat completion function to generate the response.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex91"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex91"><span></span></label> Open the <strong>ChatService.cs</strong> class file.</p></li>
<li class="task-list-item" id="taskIndex92"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex92"><span></span></label> Find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> </span><span class="typ">GetChatCompletionAsync</span></code>() function.</p></li>
<li class="task-list-item" id="taskIndex93"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex93"><span></span></label> You'll need to get vector embeddings from the user prompts. </p>
<p>Below the call to <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">GetSessionContextWindowAsync</span></code>(), add code to concatenate the context window as one string and to generate vector embeddings. </p>
<p>The 3 lines for <strong>GetSessionContextWindowAsync</strong> are included in the code block:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//Get the context window for this conversation up to the maximum conversation depth.</span><span class="pln">
</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> contextWindow </span><span class="pun">=</span><span class="pln"> 
    </span><span class="kwd">await</span><span class="pln"> _cosmosDbService</span><span class="pun">.</span><span class="typ">GetSessionContextWindowAsync</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> _maxContextWindow</span><span class="pun">);</span><span class="pln">

</span><span class="com">//Serialize the user prompts for the context window</span><span class="pln">
</span><span class="kwd">string</span><span class="pln"> prompts </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">string</span><span class="pun">.</span><span class="typ">Join</span><span class="pun">(</span><span class="typ">Environment</span><span class="pun">.</span><span class="typ">NewLine</span><span class="pun">,</span><span class="pln"> contextWindow</span><span class="pun">.</span><span class="typ">Select</span><span class="pun">(</span><span class="pln">m </span><span class="pun">=&gt;</span><span class="pln"> m</span><span class="pun">.</span><span class="typ">Prompt</span><span class="pun">));</span><span class="pln">

</span><span class="com">//Generate embeddings for the user prompts for search</span><span class="pln">
</span><span class="kwd">float</span><span class="pun">[]</span><span class="pln"> promptVectors </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">GetEmbeddingsAsync</span><span class="pun">(</span><span class="pln">prompts</span><span class="pun">);</span></code></pre>
<p>
<img src="./r49dseq1.jpg" alt="r49dseq1.jpg"></p>
<blockquote class="note">
  <p>The call to <strong>GetEmbeddingsAsync()</strong> that you added generates vector embeddings out of the user prompt using Semantic Kernel and Azure OpenAI.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex94"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex94"><span></span></label> Directly below these lines, add the line to create <strong>vectorSearchResults</strong> with the value from the <strong>SearchProductsAsync()</strong> function you completed earlier.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//RAG Pattern Vector search results for product data</span><span class="pln">
</span><span class="kwd">string</span><span class="pln"> vectorSearchResults </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">SearchProductsAsync</span><span class="pun">(</span><span class="pln">promptVectors</span><span class="pun">,</span><span class="pln"> _productMaxResults</span><span class="pun">);</span></code></pre>
<p>
<img src="./8hqhe2ms.jpg" alt="8hqhe2ms.jpg"></p></li>
<li class="task-list-item" id="taskIndex95"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex95"><span></span></label> Below that line, use the following to replace the <strong>(chatMessage.Completion</strong> line with a call to our new function <strong>GetRagCompletionAsync()</strong>. </p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//(chatMessage.Completion, chatMessage.CompletionTokens) = await _semanticKernelService.GetChatCompletionAsync(contextWindow);</span><span class="pln">

</span><span class="com">//Call Semantic Kernel to do a vector search to generate a new completion</span><span class="pln">
</span><span class="pun">(</span><span class="pln">chatMessage</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">GenerationTokens</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">CompletionTokens</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">GetRagCompletionAsync</span><span class="pun">(</span><span class="pln">contextWindow</span><span class="pun">,</span><span class="pln"> vectorSearchResults</span><span class="pun">);</span></code></pre>
<p>
<img src="./ag435jf5.jpg" alt="ag435jf5.jpg"></p>
<blockquote class="note">
  <p>This takes vectors returned from our product search above. </p>
</blockquote></li>
<li class="task-list-item" id="taskIndex96"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex96"><span></span></label> Save the <strong>ChatService.cs</strong> file.</p></li>
</ol>
</div><div class="page" id="page20">
<h2 id="05-check-your-work">05: Check your work</h2>
<p>Take the Intelligent Assistant for a test ride. Ask about different available bikes. If everything lines up - AI responses referencing the correct data - your RAG pipeline is good to go.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex97"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex97"><span></span></label> In your terminal, start the application:</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">dotnet run</span></code></p></li>
<li class="task-list-item" id="taskIndex98"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex98"><span></span></label> <strong>Ctrl+click</strong> the URL on the <strong>Login to the dashboard</strong> line.</p></li>
<li class="task-list-item" id="taskIndex99"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex99"><span></span></label> Select the <strong>http://localhost:8100</strong> endpoint.</p></li>
<li class="task-list-item" id="taskIndex100"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex100"><span></span></label> Select <strong>Create New Chat</strong> on the left, then select the <strong>New Chat</strong> tile that was created.</p></li>
<li class="task-list-item" id="taskIndex101"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex101"><span></span></label> Test its new vector search, system prompt, and response generation by entering: <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> bikes </span><span class="kwd">do</span><span class="pln"> you have</span><span class="pun">?</span></code> </p>
<blockquote class="note">
  <p>The AI assistant should respond with a list of bikes available from the product catalog. </p>
</blockquote>
<blockquote class="note">
  <p>Notice the number of <strong>Generation Tokens</strong> and the <strong>Time</strong> are now significantly higher because you're passing in more data for the model to analyze. We'll look at optimizing this in the next task.</p>
</blockquote>
<p>
<img src="./wkme7a1x.jpg" alt="wkme7a1x.jpg"></p></li>
<li class="task-list-item" id="taskIndex102"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex102"><span></span></label> Ask a follow-up question: <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">Do</span><span class="pln"> you have mountain bikes</span><span class="pun">?</span></code></p>
<p>
<img src="./iw1x98ky.jpg" alt="iw1x98ky.jpg"></p></li>
<li class="task-list-item" id="taskIndex103"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex103"><span></span></label> Close the browser window.</p></li>
<li class="task-list-item" id="taskIndex104"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex104"><span></span></label> End the process in the terminal by selecting <strong>Ctrl+C</strong>.</p></li>
</ol>
<p></p><details>
    <summary>Is your application not working or throwing exceptions? Select here to compare your code against this example.</summary><p></p>
<p><br></p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex105"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex105"><span></span></label> Validate that the <strong>GetChatCompletionAsync()</strong> function in the <strong>ChatService</strong> matches this sample.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> </span><span class="typ">GetChatCompletionAsync</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> tenantId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> promptText</span><span class="pun">)</span><span class="pln">    
</span><span class="pun">{</span><span class="pln">        
    </span><span class="com">//Create a message object for the new User Prompt and calculate the tokens for the prompt        </span><span class="pln">
    </span><span class="typ">Message</span><span class="pln"> chatMessage </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> </span><span class="typ">CreateChatMessageAsync</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> promptText</span><span class="pun">);</span><span class="pln">        

    </span><span class="com">//Get the context window for this conversation up to the maximum conversation depth        </span><span class="pln">
    </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> contextWindow </span><span class="pun">=</span><span class="pln"> 
        </span><span class="kwd">await</span><span class="pln"> _cosmosDbService</span><span class="pun">.</span><span class="typ">GetSessionContextWindowAsync</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> _maxContextWindow</span><span class="pun">);</span><span class="pln">        

    </span><span class="com">//Serialize the user prompts for the context window        </span><span class="pln">
    </span><span class="kwd">string</span><span class="pln"> prompts </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">string</span><span class="pun">.</span><span class="typ">Join</span><span class="pun">(</span><span class="typ">Environment</span><span class="pun">.</span><span class="typ">NewLine</span><span class="pun">,</span><span class="pln"> contextWindow</span><span class="pun">.</span><span class="typ">Select</span><span class="pun">(</span><span class="pln">m </span><span class="pun">=&gt;</span><span class="pln"> m</span><span class="pun">.</span><span class="typ">Prompt</span><span class="pun">));</span><span class="pln">            

    </span><span class="com">//Generate embeddings for the user prompts for search        </span><span class="pln">
    </span><span class="kwd">float</span><span class="pun">[]</span><span class="pln"> promptVectors </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">GetEmbeddingsAsync</span><span class="pun">(</span><span class="pln">prompts</span><span class="pun">);</span><span class="pln">        

    </span><span class="com">//RAG Pattern Vector search results for product data        </span><span class="pln">
    </span><span class="kwd">string</span><span class="pln"> vectorSearchResults </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">SearchProductsAsync</span><span class="pun">(</span><span class="pln">promptVectors</span><span class="pun">,</span><span class="pln"> _productMaxResults</span><span class="pun">);</span><span class="pln">               

    </span><span class="com">//Call Semantic Kernel to do a vector search to generate a new completion        </span><span class="pln">
    </span><span class="pun">(</span><span class="pln">chatMessage</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">GenerationTokens</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">CompletionTokens</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> 
        </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">GetRagCompletionAsync</span><span class="pun">(</span><span class="pln">contextWindow</span><span class="pun">,</span><span class="pln"> vectorSearchResults</span><span class="pun">);</span><span class="pln">        

    </span><span class="com">//Persist the prompt/completion, elapsed time, update the session tokens in chat history        </span><span class="pln">
    </span><span class="kwd">await</span><span class="pln"> </span><span class="typ">UpdateSessionAndMessage</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">);</span><span class="pln">        

    </span><span class="kwd">return</span><span class="pln"> chatMessage</span><span class="pun">;</span><span class="pln">    
</span><span class="pun">}</span></code></pre></li>
<li><p>If you get responses indicating there was no data to generate a response, the vector search is likely not working as expected. Navigate to the <strong>SemanticKernelService</strong> and locate the <strong>SearchProductsAsync()</strong> method to make sure that your code matches this sample.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="str">&lt;string&gt;</span><span class="pln"> </span><span class="typ">SearchProductsAsync</span><span class="pun">(</span><span class="typ">ReadOnlyMemory</span><span class="str">&lt;float&gt;</span><span class="pln"> promptVectors</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> productMaxResults</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> options </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">VectorSearchOptions</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="typ">VectorPropertyName</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">"vectors"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Top</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> productMaxResults </span><span class="pun">};</span><span class="pln">

    </span><span class="com">//Call Semantic Kernel to perform the vector search</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> searchResult </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _productContainer</span><span class="pun">.</span><span class="typ">VectorizedSearchAsync</span><span class="pun">(</span><span class="pln">promptVectors</span><span class="pun">,</span><span class="pln"> options</span><span class="pun">);</span><span class="pln">

    </span><span class="kwd">var</span><span class="pln"> resultRecords </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">VectorSearchResult</span><span class="pun">&lt;</span><span class="typ">Product</span><span class="pun">&gt;&gt;();</span><span class="pln">
    </span><span class="kwd">await</span><span class="pln"> </span><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> result </span><span class="kwd">in</span><span class="pln"> searchResult</span><span class="pun">.</span><span class="typ">Results</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">{</span><span class="pln">
       resultRecords</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="pln">result</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="kwd">string</span><span class="pln"> productsString </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JsonSerializer</span><span class="pun">.</span><span class="typ">Serialize</span><span class="pun">(</span><span class="pln">resultRecords</span><span class="pun">);</span><span class="pln">

    </span><span class="kwd">return</span><span class="pln"> productsString</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span></code></pre></li>
<li><p>If you get other strange behavior for the completion, it's possible the system prompt is not correct. In the <strong>SemanticKernelService</strong> locate the system prompts at the top of the class. Review <strong>_systemPromptRetailAssistant</strong> variable to make sure that your code matches this sample.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">private</span><span class="pln"> </span><span class="kwd">readonly</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> _systemPromptRetailAssistant </span><span class="pun">=</span><span class="pln"> </span><span class="pun">@</span><span class="str">"
You are an intelligent assistant for the Cosmic Works Bike Company. 
You are designed to provide helpful answers to user questions about 
bike products and accessories provided in JSON format below.

Instructions:
- Only answer questions related to the information provided below.
- Don't reference any product data not provided below.
- If you're unsure of an answer, you can say "</span><span class="pln">I don</span><span class="str">'t know" or "I'</span><span class="pln">m </span><span class="kwd">not</span><span class="pln"> sure</span><span class="str">" and recommend users search themselves.

Text of relevant information:"</span><span class="pun">;</span></code></pre></li>
<li><p>Finally, if the responses do not include any information on the bike products being asked, it's possible the call to Azure OpenAI Service is not correct. In the <strong>SemanticKernelService</strong> locate the <strong>GetRagCompletionAsync()</strong> method to make sure that your code matches this sample.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;(</span><span class="kwd">string</span><span class="pln"> completion</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> generationTokens</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> completionTokens</span><span class="pun">)&gt;</span><span class="pln"> </span><span class="typ">GetRagCompletionAsync</span><span class="pun">(</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> contextWindow</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> ragData</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="com">//Manage token consumption per request by trimming the amount of vector search data sent to the model</span><span class="pln">
    ragData </span><span class="pun">=</span><span class="pln"> </span><span class="typ">TrimToTokenLimit</span><span class="pun">(</span><span class="pln">_maxRagTokens</span><span class="pun">,</span><span class="pln"> ragData</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Add the system prompt and vector search data to the chat history</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> skChatHistory </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ChatHistory</span><span class="pun">();</span><span class="pln">
    skChatHistory</span><span class="pun">.</span><span class="typ">AddSystemMessage</span><span class="pun">(</span><span class="pln">_systemPromptRetailAssistant </span><span class="pun">+</span><span class="pln"> ragData</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Manage token consumption by trimming the amount of chat history sent to the model</span><span class="pln">
    </span><span class="com">//Useful if the chat history is very large. It can also be summarized before sending to the model</span><span class="pln">
    </span><span class="kwd">int</span><span class="pln"> currentTokens </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">

    </span><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> message </span><span class="kwd">in</span><span class="pln"> contextWindow</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">{</span><span class="pln">
        </span><span class="com">//Add up to the max tokens allowed</span><span class="pln">
        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">currentTokens </span><span class="pun">+=</span><span class="pln"> message</span><span class="pun">.</span><span class="typ">PromptTokens</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> message</span><span class="pun">.</span><span class="typ">CompletionTokens</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> _maxContextTokens</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">break</span><span class="pun">;</span><span class="pln">

        skChatHistory</span><span class="pun">.</span><span class="typ">AddUserMessage</span><span class="pun">(</span><span class="pln">message</span><span class="pun">.</span><span class="typ">Prompt</span><span class="pun">);</span><span class="pln">
        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">message</span><span class="pun">.</span><span class="typ">Completion</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">string</span><span class="pun">.</span><span class="typ">Empty</span><span class="pun">)</span><span class="pln">
            skChatHistory</span><span class="pun">.</span><span class="typ">AddAssistantMessage</span><span class="pun">(</span><span class="pln">message</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="typ">PromptExecutionSettings</span><span class="pln"> settings </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">{</span><span class="pln">
        </span><span class="typ">ExtensionData</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Dictionary</span><span class="pun">&lt;</span><span class="kwd">string</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">object</span><span class="pun">&gt;()</span><span class="pln">
        </span><span class="pun">{</span><span class="pln">
            </span><span class="pun">{</span><span class="pln"> </span><span class="str">"temperature"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.2</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
            </span><span class="pun">{</span><span class="pln"> </span><span class="str">"top_p"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.7</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
            </span><span class="pun">{</span><span class="pln"> </span><span class="str">"max_tokens"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1000</span><span class="pln">  </span><span class="pun">}</span><span class="pln">
        </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">};</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> result </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> kernel</span><span class="pun">.</span><span class="typ">GetRequiredService</span><span class="pun">&lt;</span><span class="typ">IChatCompletionService</span><span class="pun">&gt;().</span><span class="typ">GetChatMessageContentAsync</span><span class="pun">(</span><span class="pln">skChatHistory</span><span class="pun">,</span><span class="pln"> settings</span><span class="pun">);</span><span class="pln">

    </span><span class="typ">ChatTokenUsage</span><span class="pln"> completionUsage </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ChatTokenUsage</span><span class="pun">)</span><span class="pln">result</span><span class="pun">.</span><span class="typ">Metadata</span><span class="pun">![</span><span class="str">"Usage"</span><span class="pun">]!;</span><span class="pln">

    </span><span class="kwd">string</span><span class="pln"> completion </span><span class="pun">=</span><span class="pln"> result</span><span class="pun">.</span><span class="typ">Items</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="typ">ToString</span><span class="pun">()!;</span><span class="pln">

    </span><span class="com">//Separate the amount of tokens used to process the completion vs. the tokens used on the returned text of the completion</span><span class="pln">
    </span><span class="com">//The completion text is fed into subsequent requests so we want an accurate count of tokens for that text in case</span><span class="pln">
    </span><span class="kwd">int</span><span class="pln"> generationTokens </span><span class="pun">=</span><span class="pln"> completionUsage</span><span class="pun">.</span><span class="typ">TotalTokenCount</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> completionUsage</span><span class="pun">.</span><span class="typ">OutputTokenCount</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">int</span><span class="pln"> completionTokens </span><span class="pun">=</span><span class="pln"> completionUsage</span><span class="pun">.</span><span class="typ">OutputTokenCount</span><span class="pun">;</span><span class="pln">

    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">completion</span><span class="pun">,</span><span class="pln"> generationTokens</span><span class="pun">,</span><span class="pln"> completionTokens</span><span class="pun">);</span><span class="pln">
</span><span class="pun">}</span></code></pre>
<p></p></li></ol></details><p></p>

<hr>
<p><strong>Congratulations</strong>, you completed this task!</p>
</div><div class="page" id="page21">
<h1 id="task-05-implement-a-semantic-cache">Task 05: Implement a semantic cache</h1>
<h2 id="introduction-4">Introduction</h2>
<p>Large language models are amazing with their ability to generate completions to a user's questions. However, these requests to generate completions from an LLM are computationally expensive (expressed in tokens) and can also be quite slow. The cost and latency increase as the amount of text increases. </p>
<p>Applications following the RAG Pattern use data from a database to augment or <em>ground</em> the LLM by providing additional information to generate a more contextual response. Payloads now must include the user prompt, conversation history, and additional data from the database, which can get rather large. It's not uncommon to consume thousands of tokens and wait for five or more seconds for a response for large payloads. In a world where milliseconds count, waiting several seconds is often an unacceptable user experience.</p>
<p>Thankfully, you can create a cache for this type of solution to reduce both cost and latency for repeated prompts. In this task, you'll introduce a specialized cache called a <strong>semantic cache</strong>. Traditional caches are key-value pairs and use an equality match on the key to <em>get</em> data. Keys for a semantic cache are vectors (or embeddings) which represent words in a high dimensional space where words with similar meaning or intent are in close proximity to each other dimensionally.</p>
<p>A cache <strong>GET</strong> is done with a specialized <strong>vector query</strong> comparing the proximity of these vectors to find matches. The results are the cached completions previously generated by an LLM and a <strong>similarity score</strong> that represents how close the vectors are to each other. Similarity values range from <strong>0</strong> (no similarity) to <strong>1</strong> (exact match). </p>
<p>To execute a vector query for a semantic cache, user text is converted into vectors and then used as the filter predicate to search for similar vectors in the cache. For our semantic cache, you'll create a query that returns just one result, and the similarity score helps dial in how close the user's intent and words are to the cache's key values. The greater the score, the more similar the words and intent. The lower the score, the less similar the words <em>and potentially</em> intent as well.</p>
<p>In practice, setting this value can be tricky. Too high, and the cache will fill up with multiple responses for very similar questions. Too low, and the cache will return irrelevant responses that don't satisfy the user.</p>
<h2 id="description-4">Description</h2>
<p>In this task, you'll implement a semantic cache to optimize response times and reduce AI computation for repeated or similar user queries. You'll store previous prompts and generated answers as vector embeddings in a dedicated collection, configure a similarity threshold for retrieving relevant cached entries, and validate that repeated or closely matching queries are served from the cache without re-calling the LLM.</p>
<h2 id="success-criteria-4">Success criteria</h2>
<ul>
<li>When you asked repeated or similar questions, you got a cache hit, returning an answer without re-calling the LLM.</li>
<li>You noticed fewer calls to Azure OpenAI (and thus fewer tokens consumed) for repeated queries in the logs.</li>
<li>You experienced near-instant answers once an identical or closely similar query had been asked before.</li>
</ul>
<h2 id="learning-resources-4">Learning resources</h2>
<ul>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/azure/cosmos-db/gen-ai/semantic-cache" target="_blank" aria-label="(opens a new window)">Introduction to Semantic Cache</a>  </li>
<li><a class="icon-link external-link" href="https://techcommunity.microsoft.com/blog/azurearchitectureblog/optimize-azure-openai-applications-with-semantic-caching/4106867" target="_blank" aria-label="(opens a new window)">Optimizing Azure OpenAI applications with semantic caching</a>  </li>
</ul>
</div><div class="page" id="page22">
<h2 id="01-building-a-semantic-cache">01: Building a semantic cache</h2>
<p>By saving user queries and completions as embeddings, you enable quick lookups for near-duplicate questions. For CWBC, this means faster answers about top-selling bikes or route suggestions, plus drastically lower cloud usage costs.
Let's build our semantic cache using Azure Cosmos DB for NoSQL.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex106"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex106"><span></span></label> Open the <strong>CosmosDbService.cs</strong> class file. </p></li>
<li class="task-list-item" id="taskIndex107"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex107"><span></span></label> Find the function called <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">GetCacheAsync</span></code>() with the signature below.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="str">&lt;string&gt;</span><span class="pln"> </span><span class="typ">GetCacheAsync</span><span class="pun">(</span><span class="kwd">float</span><span class="pun">[]</span><span class="pln"> vectors</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">double</span><span class="pln"> similarityScore</span><span class="pun">)</span></code></pre></li>
<li class="task-list-item" id="taskIndex108"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex108"><span></span></label> Replace the <strong>string queryText</strong> line with the vector search query, using the following:</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//string queryText = $"";</span><span class="pln">
</span><span class="kwd">string</span><span class="pln"> queryText </span><span class="pun">=</span><span class="pln"> $</span><span class="str">"""
SELECT Top 1 
    c.prompt, c.completion, VectorDistance(c.vectors, @vectors) as similarityScore
FROM c  
WHERE 
    VectorDistance(c.vectors, @vectors) &gt; @similarityScore 
ORDER BY 
    VectorDistance(c.vectors, @vectors)
"""</span><span class="pun">;</span></code></pre>
<p>
<img src="./rvsr2vty.jpg" alt="rvsr2vty.jpg"></p>
<blockquote class="note">
  <p>This query performs the search to find relevant items in our semantic cache. It selects only the closest match with an <strong>ORDER BY</strong>, so the item with the highest similarity score (and most similar to what is being searched) appears first. The results include a previously cached completion, and the similarity score for the cached item.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex109"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex109"><span></span></label> Save <strong>CosmosDbService.cs</strong>.</p></li>
<li class="task-list-item" id="taskIndex110"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex110"><span></span></label> Open <strong>ChatService.cs</strong>. You'll need to call the <strong>GetCacheAsync()</strong> function from the LLM pipeline. </p></li>
<li class="task-list-item" id="taskIndex111"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex111"><span></span></label> Find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> </span><span class="typ">GetChatCompletionAsync</span></code>() function.</p>
<blockquote class="note">
  <p>You'll modify this function to search our semantic cache for user prompts with a similar intent to what is being asked. If we find a match, we can return the cached value to the user instead of making a new request to the LLM.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex112"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex112"><span></span></label> Below the existing <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">float</span><span class="pun">[]</span><span class="pln"> promptVectors</span></code> declaration in the function, add a call to the <strong>GetCacheAsync()</strong> function that you just updated.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//Perform a cache search for the same sequence and depth of prompts in this conversation</span><span class="pln">
</span><span class="kwd">string</span><span class="pln"> cacheResponse </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _cosmosDbService</span><span class="pun">.</span><span class="typ">GetCacheAsync</span><span class="pun">(</span><span class="pln">promptVectors</span><span class="pun">,</span><span class="pln"> _cacheSimilarityScore</span><span class="pun">);</span></code></pre>
<p>
<img src="./nyn5ehhw.jpg" alt="nyn5ehhw.jpg"></p>
<blockquote class="note">
  <p>To query our cache for past responses to similar prompts, you execute the vector search. </p>
</blockquote></li>
<li class="task-list-item" id="taskIndex113"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex113"><span></span></label> Below the call you just added, add the following: </p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//Cache hit, return the cached completion</span><span class="pln">
</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="kwd">string</span><span class="pun">.</span><span class="typ">IsNullOrEmpty</span><span class="pun">(</span><span class="pln">cacheResponse</span><span class="pun">))</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    chatMessage</span><span class="pun">.</span><span class="typ">CacheHit</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
    chatMessage</span><span class="pun">.</span><span class="typ">Completion</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> cacheResponse</span><span class="pun">;</span><span class="pln">

</span><span class="com">//Persist the prompt/completion, elapsed time, update the session tokens</span><span class="pln">
    </span><span class="kwd">await</span><span class="pln"> </span><span class="typ">UpdateSessionAndMessage</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> chatMessage</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span></code></pre>
<p>
<img src="./fijh4nay.jpg" alt="fijh4nay.jpg"></p>
<blockquote class="note">
  <p>If <strong>cacheResponse</strong> is populated, that means it found a matching response to give the user and can skip the rest of the function and return the cached completion. If there wasn't a cache hit, this <strong>if</strong> statement is skipped and the rest of the LLM pipeline is executed to search for relevant products and generate a new completion using the Semantic Kernel Service.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex114"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex114"><span></span></label> Find the call to <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">GetRagCompletionAsync</span></code>(). Below it, add a call to update the cache.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//Cache the prompts in the current context window and their vectors with the generated completion</span><span class="pln">
</span><span class="kwd">await</span><span class="pln"> _cosmosDbService</span><span class="pun">.</span><span class="typ">CachePutAsync</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">CacheItem</span><span class="pun">(</span><span class="pln">promptVectors</span><span class="pun">,</span><span class="pln"> prompts</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">));</span></code></pre>
<p>
<img src="./ia2cyudr.jpg" alt="ia2cyudr.jpg"></p>
<blockquote class="note">
  <p>This updates the function to store new prompts and completions in the cache to use in the future.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex115"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex115"><span></span></label> Save the <strong>ChatService.cs</strong> file.</p></li>
</ol>
<hr>
<h3 id="check-your-work">Check your work</h3>
<p>Before you test our new semantic cache, verify your code is correct. Select "Compare your code against this example" to check if your code is correct.</p>
<p></p><details>
    <summary>Compare your code against this example.</summary><p></p>
<p><br></p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex116"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex116"><span></span></label> Review the <strong>GetChatCompletionAsync()</strong> method of the <strong>ChatService.cs</strong> code file to make sure that your code matches this sample.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">async</span><span class="pln"> </span><span class="typ">Task</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> </span><span class="typ">GetChatCompletionAsync</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> tenantId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> promptText</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="com">//Create a message object for the new User Prompt and calculate the tokens for the prompt</span><span class="pln">
    </span><span class="typ">Message</span><span class="pln"> chatMessage </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> </span><span class="typ">CreateChatMessageAsync</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> promptText</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Get the context window for this conversation up to the maximum conversation depth</span><span class="pln">
    </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Message</span><span class="pun">&gt;</span><span class="pln"> contextWindow </span><span class="pun">=</span><span class="pln"> 
        </span><span class="kwd">await</span><span class="pln"> _cosmosDbService</span><span class="pun">.</span><span class="typ">GetSessionContextWindowAsync</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> _maxContextWindow</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Serialize the user prompts for the context window</span><span class="pln">
    </span><span class="kwd">string</span><span class="pln"> prompts </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">string</span><span class="pun">.</span><span class="typ">Join</span><span class="pun">(</span><span class="typ">Environment</span><span class="pun">.</span><span class="typ">NewLine</span><span class="pun">,</span><span class="pln"> contextWindow</span><span class="pun">.</span><span class="typ">Select</span><span class="pun">(</span><span class="pln">m </span><span class="pun">=&gt;</span><span class="pln"> m</span><span class="pun">.</span><span class="typ">Prompt</span><span class="pun">));</span><span class="pln">

    </span><span class="com">//Generate embeddings for the user prompts for search</span><span class="pln">
    </span><span class="kwd">float</span><span class="pun">[]</span><span class="pln"> promptVectors </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">GetEmbeddingsAsync</span><span class="pun">(</span><span class="pln">prompts</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Perform a cache search for the same sequence and depth of prompts in this conversation</span><span class="pln">
    </span><span class="kwd">string</span><span class="pln"> cacheResponse </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _cosmosDbService</span><span class="pun">.</span><span class="typ">GetCacheAsync</span><span class="pun">(</span><span class="pln">promptVectors</span><span class="pun">,</span><span class="pln"> _cacheSimilarityScore</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Cache hit, return the cached completion</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="kwd">string</span><span class="pun">.</span><span class="typ">IsNullOrEmpty</span><span class="pun">(</span><span class="pln">cacheResponse</span><span class="pun">))</span><span class="pln">
    </span><span class="pun">{</span><span class="pln">
       chatMessage</span><span class="pun">.</span><span class="typ">CacheHit</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
       chatMessage</span><span class="pun">.</span><span class="typ">Completion</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> cacheResponse</span><span class="pun">;</span><span class="pln">

       </span><span class="com">//Persist the prompt/completion, elapsed time, update the session tokens</span><span class="pln">
       </span><span class="kwd">await</span><span class="pln"> </span><span class="typ">UpdateSessionAndMessage</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">);</span><span class="pln">

       </span><span class="kwd">return</span><span class="pln"> chatMessage</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">

    </span><span class="com">//RAG Pattern Vector search results for product data</span><span class="pln">
    </span><span class="kwd">string</span><span class="pln"> vectorSearchResults </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">SearchProductsAsync</span><span class="pun">(</span><span class="pln">promptVectors</span><span class="pun">,</span><span class="pln"> _productMaxResults</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Call Semantic Kernel to generate a new completion</span><span class="pln">
    </span><span class="pun">(</span><span class="pln">chatMessage</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">GenerationTokens</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">CompletionTokens</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> 
        </span><span class="kwd">await</span><span class="pln"> _semanticKernelService</span><span class="pun">.</span><span class="typ">GetRagCompletionAsync</span><span class="pun">(</span><span class="pln">contextWindow</span><span class="pun">,</span><span class="pln"> vectorSearchResults</span><span class="pun">);</span><span class="pln">

    </span><span class="com">//Cache the prompts in the current context window and their vectors with the generated completion</span><span class="pln">
    </span><span class="kwd">await</span><span class="pln"> _cosmosDbService</span><span class="pun">.</span><span class="typ">CachePutAsync</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">CacheItem</span><span class="pun">(</span><span class="pln">promptVectors</span><span class="pun">,</span><span class="pln"> prompts</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">.</span><span class="typ">Completion</span><span class="pun">));</span><span class="pln">

    </span><span class="com">//Persist the prompt/completion, elapsed time, update the session tokens in chat history</span><span class="pln">
    </span><span class="kwd">await</span><span class="pln"> </span><span class="typ">UpdateSessionAndMessage</span><span class="pun">(</span><span class="pln">tenantId</span><span class="pun">,</span><span class="pln"> userId</span><span class="pun">,</span><span class="pln"> sessionId</span><span class="pun">,</span><span class="pln"> chatMessage</span><span class="pun">);</span><span class="pln">

    </span><span class="kwd">return</span><span class="pln"> chatMessage</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span></code></pre>
<p></p></li></ol></details><p></p>

</div><div class="page" id="page23">
<h2 id="02-tune-the-cache">02: Tune the cache</h2>
<p>Setting the right similarity threshold is like adjusting the tension on a bike's chain - you don't want it too loose or too tight. CWBC needs to experiment with different similarity scores so the cache is both accurate and efficient.</p>
<p>At this point, you've implemented our semantic cache and are ready to test.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex117"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex117"><span></span></label> In the VS Code terminal, start the application:</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">dotnet run</span></code></p></li>
<li class="task-list-item" id="taskIndex118"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex118"><span></span></label> <strong>Ctrl+click</strong> the URL on the <strong>Login to the dashboard</strong> line.</p></li>
<li class="task-list-item" id="taskIndex119"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex119"><span></span></label> Select the <strong>http://localhost:8100</strong> endpoint.</p></li>
<li class="task-list-item" id="taskIndex120"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex120"><span></span></label> Select <strong>Create New Chat</strong> on the left, then select the <strong>New Chat</strong> that was created.</p></li>
<li class="task-list-item" id="taskIndex121"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex121"><span></span></label> Enter <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> are the most expensive bikes</span><span class="pun">?</span></code></p>
<p>
<img src="./z248o5qy.jpg" alt="z248o5qy.jpg"></p>
<blockquote class="alert">
  <p>It's okay if you see different results or if the answers are factually inaccurate. Just ensure the flow of questions is the same, and that responses provide bikes from the product catalog.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex122"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex122"><span></span></label> Enter <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> are the least expensive</span><span class="pun">?</span></code> as a follow-up.</p>
<p>
<img src="./1gsinhp4.jpg" alt="1gsinhp4.jpg"></p></li>
<li class="task-list-item" id="taskIndex123"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex123"><span></span></label> Enter <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="str">'s a good mid range?</span></code></p>
<p>
<img src="./e0r8o0y3.jpg" alt="e0r8o0y3.jpg"></p></li>
</ol>
<hr>
<h3 id="validate-semantic-cache-is-working">Validate semantic cache is working</h3>
<p>You'll know the cache worked if you see a faster response time with no tokens consumed. They'll also have a <strong>Cache Hit: True</strong> tag appended in the upper right of the response. </p>
<p>To test, you'll repeat the above sequence with slightly modified prompts, then take the opportunity to adjust the similarity score to see its impact on how the cache works. You'll start with a very strict similarity score of <strong>0.99</strong>, which is the default for this project, then adjust it after some testing.</p>
<!-- ![cache-hit.png](../media/cache-hit.png) -->
<ol class="taskList">
<li class="task-list-item" id="taskIndex124"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex124"><span></span></label> Select <strong>Create New Chat</strong> on the left, then select the <strong>New Chat</strong> that was created.</p></li>
<li class="task-list-item" id="taskIndex125"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex125"><span></span></label> Enter a variation of the original question: <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> are the highest cost bikes</span><span class="pun">?</span></code></p>
<blockquote class="note">
  <p>Note the chatbot responds correctly, but <strong>does not</strong> hit the cache, and consumes tokens.</p>
</blockquote>
<p>
<img src="./qc8x5df0.jpg" alt="qc8x5df0.jpg"></p></li>
<li class="task-list-item" id="taskIndex126"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex126"><span></span></label> Close the web browser.</p></li>
<li class="task-list-item" id="taskIndex127"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex127"><span></span></label> Stop the application from the terminal by selecting <strong>Ctrl+C</strong>.</p></li>
<li class="task-list-item" id="taskIndex128"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex128"><span></span></label> In the <strong>ChatService.cs</strong> file, find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="kwd">public</span><span class="pln"> </span><span class="typ">ChatService</span></code>() constructor. </p></li>
<li class="task-list-item" id="taskIndex129"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex129"><span></span></label> Replace the <strong>_cacheSimilarityScore</strong> line parsing the similarity score from our settings, and adjust its value from <strong>0.99</strong> to <strong>0.8</strong>. </p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="com">//_cacheSimilarityScore = Double.TryParse(cacheSimilarityScore, out _cacheSimilarityScore) ? _cacheSimilarityScore : 0.99;</span><span class="pln">
_cacheSimilarityScore </span><span class="pun">=</span><span class="pln"> </span><span class="pun">.</span><span class="lit">8</span><span class="pun">;</span></code></pre>
<p>
<img src="./tb0ah9r6.jpg" alt="tb0ah9r6.jpg"></p></li>
<li class="task-list-item" id="taskIndex130"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex130"><span></span></label> Save the <strong>ChatService.cs</strong> file.</p></li>
<li class="task-list-item" id="taskIndex131"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex131"><span></span></label> In the terminal, start the application again:</p>
<p><code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">dotnet run</span></code></p></li>
<li class="task-list-item" id="taskIndex132"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex132"><span></span></label> <strong>Ctrl+click</strong> the URL on the <strong>Login to the dashboard</strong> line.</p></li>
<li class="task-list-item" id="taskIndex133"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex133"><span></span></label> Select the <strong>http://localhost:8100</strong> endpoint.</p></li>
<li class="task-list-item" id="taskIndex134"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex134"><span></span></label> Select <strong>Create New Chat</strong> on the left, then select the <strong>New Chat</strong> that was created.</p></li>
<li class="task-list-item" id="taskIndex135"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex135"><span></span></label> Enter <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> are the highest cost bikes</span><span class="pun">?</span></code> again.</p>
<blockquote class="note">
  <p>This time zero tokens will be used, and the <strong>Cache Hit: True</strong> tag will be appended to the response. The response should generally be much faster, as well.</p>
</blockquote>
<p>
<img src="./awhvg7lb.jpg" alt="awhvg7lb.jpg"></p></li>
<li class="task-list-item" id="taskIndex136"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex136"><span></span></label> Spend a few minutes trying different sequences of questions and follow-up questions and modifying them with different similarity scores. If you want to start over and do multiple tests using the same series of questions, you can select <strong>Clear Cache</strong> in the upper-right corner of the page.</p>
<p>
<img src="./3iji7ng4.jpg" alt="3iji7ng4.jpg"></p></li>
</ol>
<!-- 1. [] When you're done, close the browser.

1. [] Stop the application from the terminal by selecting **Ctrl+C**. -->
</div><div class="page" id="page24">
<h2 id="a-semantic-cache-needs-to-have-context">A semantic cache needs to have context</h2>
<p>If you haven't noticed by now, the semantic cache in this lab caches within the <strong>context window</strong> for a session. This is different from how traditional caches work. </p>
<p>Just as you saw earlier in the lab, context matters! Caching a conversation ensures that what gets returned from the cache is contextually correct. If the cache didn't do this, users would get unexpected, and likely unacceptable responses.</p>
<p>Here's a simple mental exercise for a semantic cache that <strong>does not</strong> cache the context window. </p>
<p>If you first ask an LLM, "What is the most expensive bike?", it will respond, then cache that user prompt and completion. If you then ask, "What is the least expensive?", the context window you built earlier will pass the chat history to the LLM and it will correctly respond with cheap bikes. The cache will store that individual user prompt and completion too.</p>
<p>Now, say another user in a different session asked, "What is the most expensive <strong>bike seat</strong>?", the LLM will respond with expensive bike seat options. If that user then asked, "What is the least expensive?", the cache will return a list of <strong>bikes</strong> from its cached completion, which of course is not what the user was looking for when they asked about bike seats.</p>
<p>This demonstrates why a semantic cache must cache within a context window. The context window already provides contextual relevance for an LLM to generate completions. This makes it a logical choice for how the cache should work. Implementing this is simple because you're already managing chat history for the app. You just send all the user prompts as a string to be vectorized, then store this with the completion that gets generated by the LLM. Then, when a user comes along later, only those with the <strong>same sequence of questions</strong> within their context window will get that specific cached response.</p>
<hr>
<p><strong>Congratulations</strong>, you completed this task!</p>
</div><div class="page" id="page25">
<h1 id="task-06-explore-the-net-aspire-dashboard">Task 06: Explore the .NET Aspire dashboard</h1>
<h2 id="introduction-5">Introduction</h2>
<p>Real-time insights matter to CWBC. Suppose a new e-bike line launches and queries spike; the .NET Aspire Dashboard helps you spot performance bottlenecks, see which calls consume the most tokens, and confirm whether your cache is kicking in. It's the command center for everything your Intelligent Assistant does.</p>
<p>The .NET Aspire dashboard is a great resource for monitoring your application in development. It helps you understand the request flow in your application and provides a centralized place for viewing traces and logs in real-time. </p>
<p>So far, you've used the .NET Aspire dashboard to launch the web application. Let's explore the other features exposed in the dashboard.</p>
<h2 id="description-5">Description</h2>
<p>In this task, you'll investigate how the Intelligent Assistant performs under the hood by using the .NET Aspire dashboard. You'll observe real-time traces, monitor how requests flow to Azure Cosmos DB and Azure OpenAI, and identify when cache hits or vector searches occur. </p>
<h2 id="success-criteria-5">Success criteria</h2>
<ul>
<li>You have real-time traces for each request (vector search, semantic cache, AI completion) in the dashboard.</li>
<li>You identified where requests spend the most time, confirmed cache hits versus misses, and observed any slow spans.</li>
<li>You know how to use the metrics and logs to troubleshoot or optimize the Intelligent Assistant's performance over time.</li>
</ul>
<h2 id="learning-resources-5">Learning resources</h2>
<ul>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/dashboard/explore" target="_blank" aria-label="(opens a new window)">Explore the .NET Aspire dashboard</a></li>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/en-us/azure/cosmos-db/nosql/sdk-observability?tabs=dotnet" target="_blank" aria-label="(opens a new window)">Azure Cosmos DB SDK observability</a></li>
</ul>
</div><div class="page" id="page26">
<h2 id="01-analyze-real-time-traces">01: Analyze real-time traces</h2>
<ol class="taskList">
<li class="task-list-item" id="taskIndex137"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex137"><span></span></label> Select <strong>Create New Chat</strong> on the left, then select the <strong>New Chat</strong> that was created.</p></li>
<li class="task-list-item" id="taskIndex138"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex138"><span></span></label> Enter <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> bike accessories </span><span class="kwd">do</span><span class="pln"> you have</span><span class="pun">?</span></code></p>
<p>
<img src="./mmd6vttx.jpg" alt="mmd6vttx.jpg"></p></li>
<li class="task-list-item" id="taskIndex139"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex139"><span></span></label> Start another new chat session, and ask the same question: <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">What</span><span class="pln"> bike accessories </span><span class="kwd">do</span><span class="pln"> you have</span><span class="pun">?</span></code> </p>
<blockquote class="note">
  <p>You should get a cache hit with an immediate response consuming zero generation tokens.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex140"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex140"><span></span></label> Go to the .NET Aspire dashboard tab in the browser. </p></li>
<li class="task-list-item" id="taskIndex141"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex141"><span></span></label> Select <strong>Traces</strong> from the left toolbar. </p>
<p>
<img src="./lo65ya3w.jpg" alt="lo65ya3w.jpg"></p>
<blockquote class="note">
  <p>You'll see all the network requests in your application represented chronologically here. Notice there are several <strong>GET</strong> calls and a <strong>POST</strong> as the Blazor application starts up. </p>
</blockquote></li>
<li class="task-list-item" id="taskIndex142"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex142"><span></span></label> Select the bottom trace to expand the service calls being made in the application. </p>
<p>
<img src="./s182yc5j.jpg" alt="s182yc5j.jpg"></p></li>
</ol>
<hr>
<p>Each request made to Azure Cosmos DB or Azure OpenAI is represented as a span. The first few spans represent background tasks in the web application to query Azure Cosmos DB for existing chats and to verify the product data has been loaded. </p>
<p>Each time a new container in Azure Cosmos DB is accessed, the SDK makes several HTTP requests to get metadata for the container. You'll see these represented as child spans. Let's explore the spans in this dashboard and correlate them to the features you implemented so far in our chat application.</p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex143"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex143"><span></span></label> Scroll down in the list of traces. If you created a new chat session for this task, find the second <strong>DATA cosmosdb CreateItemAsync chat</strong> span (the first would be to create the chat session item itself). If you didn't create a new chat session, find the first <strong>CreateItemAsync</strong>. This is the call to store your first prompt in the Azure Cosmos DB chat container. </p>
<blockquote class="note">
  <p>You may need to expand the <strong>Name</strong> column by selecting the vertical line to the left of the <strong>0s</strong> column and dragging it to the right. </p>
</blockquote></li>
<li class="task-list-item" id="taskIndex144"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex144"><span></span></label> Since we haven't asked about bike accessories yet, this was a cache miss. Let's explore the request flow and validate it matches our expectations.</p>
<p>
<img src="./tf9uoqrb.jpg" alt="tf9uoqrb.jpg"></p>
<p>Your traces should resemble the image above. If you see an error from <em>169.254.169.254:80</em>, this is a metadata request made by the SDK to get information about your compute environment. For unsupported VM types, this is expected to fail and is safe to ignore.</p>
<ol>
<li>First, there is a call to the Azure Cosmos DB chat container to store the prompt you typed in the chat.</li>
<li>Next, the call to the chat container represents building the context window. We need to query for any previous messages in the chat session to get contextually relevant results.</li>
<li>Then, this call to Azure OpenAI represents getting the vector embeddings from our prompt.</li>
<li>This call to the cache container checks if we found a cache hit by passing in the vector embeddings and performing a vector search for similar responses. Notice there are child HTTP calls under this request. That is the SDK initializing connections for the cache container. The other containers had already been used earlier on in the application and therefore had already been initialized.</li>
<li>This call represents a second round trip for the get cache query.</li>
<li>Because we had a cache miss, next we queried for products relevant to the user prompt. This call uses vector search to find products from the products container to later pass to Azure OpenAI. The product data returned is the key component for implementing the RAG pattern.</li>
<li>Next, we have the call to Azure OpenAI to get the chat completion for our prompt and RAG data. Notice the calls to Azure OpenAI have a higher duration than the rest of the calls, this is because we're sending a lot of context to the model to generate a completion.</li>
<li>After generating a completion, we store the result in the cache to avoid having to compute a response for similar questions in the future.</li>
<li>Then we call to retrieve the chat container item representing this chat session.</li>
<li>Last, we execute a bulk upload of the chat completion and session to the chat container.</li></ol>
<blockquote class="note">
  <p>This request flow maps to the LLM Pipeline we created in the <strong>ChatService/GetChatCompletionAsync()</strong> function.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex145"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex145"><span></span></label> Below the cache miss request flow, let's analyze the spans for the second prompt we gave. This time, we started another new chat session and entered the same question, generating a cache hit. You'll notice the first three spans are the same, but because we had a cache hit, there are fewer steps.</p>
<p>
<img src="./9ehgp6m4.jpg" alt="9ehgp6m4.jpg"></p>
<ol>
<li>First, there's a call to the Azure Cosmos DB chat container to store the prompt you typed in the chat.</li>
<li>Next, the call to the chat container represents building the context window. We need to query for any previous messages in the chat session to get contextually relevant results.</li>
<li>Then, this call to Azure OpenAI represents getting the vector embeddings from our prompt.</li>
<li>This call to the cache container checks if we found a cache hit by passing in the vector embeddings and performing a vector search for similar responses. Because we've already made requests to the cache container in the previous chat, there are no child span initialization calls either.</li>
<li>Then we call to retrieve the chat container item representing this chat session.</li>
<li>Last, we execute a bulk upload of the chat completion and session to the chat container.</li></ol>
<blockquote class="note">
  <p>This request flow also maps to the LLM Pipeline we created in the <strong>ChatService/GetChatCompletionAsync()</strong> function. Because we had a cache hit, we execute the code in the <strong>if</strong> statement that skips the calls to find relevant products and generate a completion from Azure OpenAI. Instead, we can return the cached completion to the user.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex146"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex146"><span></span></label> These traces and spans are emitted using OpenTelemetry, which is configured by default when you use .NET Aspire. Every SDK can provide custom OpenTelemetry attributes to add extra information to spans about the request. Azure Cosmos DB emits several custom attributes that can help you understand what's happening in your application. Select the fourth span from the previous step, which represents the query to the cache container. Optionally, select the icon to switch from horizontal to vertical view.</p>
<p>
<img src="./zv310wpx.jpg" alt="zv310wpx.jpg"></p>
<blockquote class="note">
  <p>Notice the <strong>db.cosmosdb.item_count</strong> with a value of <strong>1</strong>. This shows that we had one result returned from our query. Explore the other attributes provided and select spans for different operations to see the attributes provided for every request type.</p>
</blockquote></li>
<li class="task-list-item" id="taskIndex147"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex147"><span></span></label> Keep the .NET Aspire dashboard open and leave the application running, as you'll use it again in the next set of steps.</p></li>
</ol>
<hr>
<p>The Azure Cosmos DB SDK also emits logs through OpenTelemetry which appear in the .NET Aspire dashboard. Depending on the log level configured for your application, you can receive logs for errors and warnings. These logs are very helpful during application development to gain more information about failed or slow requests.</p>
<p>First, let's look at the log configuration for Azure Cosmos DB. </p>
<ol class="taskList">
<li class="task-list-item" id="taskIndex148"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex148"><span></span></label> Open the <strong>src/cosmos-copilot.WebApp/<code class="prettyprint prettyprinted" tabindex="0" style=""><span class="typ">Program</span><span class="pun">.</span><span class="pln">cs</span></code></strong> file. </p>
<p>
<img src="./24bcnxr1.jpg" alt="24bcnxr1.jpg"></p></li>
<li class="task-list-item" id="taskIndex149"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex149"><span></span></label> Find the <code class="prettyprint prettyprinted" tabindex="0" style=""><span class="pln">builder</span><span class="pun">.</span><span class="typ">AddAzureCosmosClient</span></code>() function call, copied again here.</p>
<pre><div class="codeTitle"><span class="title">csharp</span><span class="title"><span class="type-code-block">Type</span><span class="copy-code-block">Copy</span></span></div><code class="csharp language-csharp prettyprint prettyprinted" tabindex="0" style=""><span class="pln">builder</span><span class="pun">.</span><span class="typ">AddAzureCosmosClient</span><span class="pun">(</span><span class="pln">    
    </span><span class="str">"cosmos-copilot"</span><span class="pun">,</span><span class="pln">    
    settings </span><span class="pun">=&gt;</span><span class="pln">    
    </span><span class="pun">{</span><span class="pln">        
        settings</span><span class="pun">.</span><span class="typ">AccountEndpoint</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Uri</span><span class="pun">(</span><span class="pln">cosmosEndpoint</span><span class="pun">);</span><span class="pln">        
        settings</span><span class="pun">.</span><span class="typ">Credential</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">DefaultAzureCredential</span><span class="pun">();</span><span class="pln">        
        settings</span><span class="pun">.</span><span class="typ">DisableTracing</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">    
    </span><span class="pun">},</span><span class="pln">    
    clientOptions </span><span class="pun">=&gt;</span><span class="pln"> 
    </span><span class="pun">{</span><span class="pln">        
        clientOptions</span><span class="pun">.</span><span class="typ">ApplicationName</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">"cosmos-copilot"</span><span class="pun">;</span><span class="pln">        
        clientOptions</span><span class="pun">.</span><span class="typ">UseSystemTextJsonSerializerWithOptions</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">JsonSerializerOptions</span><span class="pun">()</span><span class="pln">        
        </span><span class="pun">{</span><span class="pln">            
            </span><span class="typ">PropertyNamingPolicy</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JsonNamingPolicy</span><span class="pun">.</span><span class="typ">CamelCase</span><span class="pln">        
        </span><span class="pun">};</span><span class="pln">        
        clientOptions</span><span class="pun">.</span><span class="typ">CosmosClientTelemetryOptions</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">()</span><span class="pln">        
        </span><span class="pun">{</span><span class="pln">            
            </span><span class="typ">CosmosThresholdOptions</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">()</span><span class="pln">            
            </span><span class="pun">{</span><span class="pln">                
                </span><span class="typ">PointOperationLatencyThreshold</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">TimeSpan</span><span class="pun">.</span><span class="typ">FromMilliseconds</span><span class="pun">(</span><span class="lit">10</span><span class="pun">),</span><span class="pln">                
                </span><span class="typ">NonPointOperationLatencyThreshold</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">TimeSpan</span><span class="pun">.</span><span class="typ">FromMilliseconds</span><span class="pun">(</span><span class="lit">20</span><span class="pun">)</span><span class="pln">            
            </span><span class="pun">}</span><span class="pln">        
        </span><span class="pun">};</span><span class="pln">    
    </span><span class="pun">});</span></code></pre>
<blockquote class="note">
  <p>Notice the <strong>clientOptions.CosmosClientTelemetryOptions</strong> call. This is where threshold options are configured for emitting logs from Azure Cosmos DB requests. </p>
</blockquote>
<blockquote class="knowledge">
  <p>There are separate configurations for <strong>PointOperationLatencyThreshold</strong> and <strong>NonPointOperationLatencyThreshold</strong> because requests interacting with a single item are frequently much lower latency than multi-item operations. These two thresholds are set extremely low in this application to ensure you have some logs to look at. </p>
  <p>In a production application, you likely want to set this to a higher value to avoid having noisy logs for every request.</p>
</blockquote><div class="moreKnowledge"><a href="https://labclient.labondemand.com/Instructions/e013c27b-7e28-4b7b-a514-ffe8a76c35a1#" class="moreKnowledgeLink">more...</a></div></li>
<li class="task-list-item" id="taskIndex150"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex150"><span></span></label> In the .NET Aspire dashboard, select <strong>Structured</strong> on the left menu. </p>
<p>
<img src="./l77ovlqx.jpg" alt="l77ovlqx.jpg"></p></li>
<li class="task-list-item" id="taskIndex151"><p><label class="checkbox"><input type="checkbox" aria-labelledby="taskIndex151"><span></span></label> Select any of the warnings with a <strong>ThresholdViolation</strong>. </p>
<p>
<img src="./shv6r27z.jpg" alt="shv6r27z.jpg"></p>
<blockquote class="note">
  <p>These represent requests that had higher latency than the thresholds you configured while creating our Cosmos client. The <strong>Message</strong> contains the Azure Cosmos DB diagnostic string with detailed information about the request.</p>
</blockquote></li>
</ol>
</div><div class="page" id="page27">
<h1 id="summary">Summary</h1>
<p>You've successfully implemented our new generative AI application using Azure Cosmos DB and Azure OpenAI Service. You've learned new concepts for building generative AI applications such as tokens, context windows, semantic caching, similarity scores, and RAG Pattern.</p>
<p>With the SDKs for Azure Cosmos DB for NoSQL and Semantic Kernel including its extensions and connectors, you were able to add these services to your application with little friction. The services you implemented illustrate the best practices for using each SDK across various operations. The .NET SDKs for each service made it possible to add the required functionality to your ASP.NET Core Blazor web application using .NET Aspire with lightweight method implementations.</p>
<hr>
<h2 id="references">References</h2>
<p>This hands on lab is available as a completed sample here, <a class="icon-link external-link" href="https://github.com/AzureCosmosDB/cosmosdb-nosql-copilot" target="_blank" aria-label="(opens a new window)">Build a custom Copilot application.</a></p>
<p>Take some time to explore the services and capabilities you saw today to get more familiar with them.</p>
<ul>
<li><strong>Semantic Kernel</strong><ul>
<li><a class="icon-link external-link" href="https://learn.microsoft.com/semantic-kernel/overview/" target="_blank" aria-label="(opens a new window)">Get started with semantic kernel</a></li></ul></li>
<li><strong>Azure Cosmos DB Vector Search</strong><ul>
<li><a class="icon-link external-link" href="https://aka.ms/CosmosDBVectorSetup" target="_blank" aria-label="(opens a new window)">Get started with vector search in Azure Cosmos DB</a></li></ul></li>
</ul>
<p>Take your knowledge even further. We've built a complete end-to-end RAG Pattern solution that takes this lab you did today and expands it to a fully functional, production grade solution accelerator. The solution has the same ASP.NET Blazor web interface and the back end is entirely built using the latest features from Semantic Kernel. The solution can be deployed to either AKS or Azure Container Apps, along with a host of other services designed for deploying production grade applications in Azure.</p>
<ul>
<li><strong>Official Microsoft Solution Accelerator for building RAG pattern applications</strong><ul>
<li><a class="icon-link external-link" href="https://github.com/Azure/BuildYourOwnCopilot" target="_blank" aria-label="(opens a new window)">Build your own Copilot Solution Accelerator</a></li></ul></li>
</ul>
</div><div class="page" id="page28">
<h3 id="conclusion">Conclusion</h3>
<p><strong>Congratulations!</strong> You've successfully completed this task and have completed the <strong>Build a serverless, AI RAG application using data from Azure Cosmos DB</strong> lab!</p></div></div>
                </div>
                <div class="instructions-footer primary-color-low-opacity-border">
                    <div id="instructionsNavigation" class="instructions-navigation" role="navigation" aria-label="Previous/Next">
                        <button id="previous" class="previous-button icon noselect disabled" title="" tabindex="-1" aria-disabled="true">Previous</button>
                        <button id="next" class="next-button icon noselect" title="Next: Sign to the lab VM">Next</button>
                    </div>
                    <div class="progress-and-timer-wrapper">
                        <div id="taskProgressBar" class="lab-progress-bar primary-color-low-opacity-background" tabindex="0" title="0/152 (0%) Tasks Complete" style="">
                            <div id="taskProgress" class="lab-progress-fill primary-color-background" style="width: 0%;"></div>
                        </div>
                        <div id="timerWrapper" class="timer-wrapper">
                            <span id="timer" class="timer primary-color" tabindex="0">2 Hr 21 Min Remaining</span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="resourcesTab" class="tab  resources">
                <div class="tab-content">
                    <div class="zoomable">
                        <div id="cloudCredentials"><div class="cloudCredential"><h2>Azure Portal</h2><table class="credentials fields"><tbody><tr><td class="fieldName">URL</td><td><a class="portalLink home icon-link special-action-link" href="https://portal.azure.com/#home">https://portal.azure.com/#home</a></td></tr><tr><td class="fieldName">Subscription</td><td><span class="typeText" title="Type Text" tabindex="0" role="button" aria-description="Azure Portal Type Text Subscription">5dcaf8b8-40da-49ae-ae53-6bbeb253e8af</span></td></tr><tr><td class="fieldName">Username</td><td><span class="typeText" title="Type Text" tabindex="0" role="button" aria-description="Azure Portal Type Text Username">User1-55844333@LODSPRODMCA.onmicrosoft.com</span></td></tr><tr><td class="fieldName">Password</td><td><span class="typeText" title="Type Text" tabindex="0" role="button" aria-description="Azure Portal Type Text Password">Hk0Be9!!Ddq!</span></td></tr><tr><td class="fieldName"><abbr title="Temporary Access Pass">TAP</abbr></td><td><span class="typeText" title="Type Text" tabindex="0" role="button" aria-description="Azure Portal Type Text TAP">NcQg*QUJ</span></td></tr></tbody></table></div></div>
                        <div id="cloudResources"><div class="cloudResourceGroup"><h2>Resource Group<div class="description">ResourceGroup1</div></h2></div></div>
                        <div id="resourcesExtensions"><div class="machine hoverColor selectedColor activeColor accent-background selected" id="machine326266"><img alt="Thumbnail screenshot of virtual machineLab55844333-Build Base VM" class="thumbnail" src="./saved_resource">
            <div class="machineNameCenter">
                <div class="machineName">Build Base VM</div>
            </div>
            <div class="inputRelease">
                To release mouse, press <strong>Ctrl+Alt+Left Arrow</strong>
            </div>
            <div class="machineInfo" style="">
                <table class="credentials fields">
                    <tbody><tr>
                        <td class="fieldName">Username</td>
                        <td><span class="typeText username" title="Type Text" role="button" tabindex="0" aria-description="Build Base VM Type Text Username">Admin</span></td>
                    </tr>
                    <tr>
                        <td class="fieldName">Password</td>
                        <td><span class="typeText password" title="Type Text" role="button" tabindex="0" aria-description="Build Base VM Type Text Password">Passw0rd!</span></td>
                    </tr>
                </tbody></table>
                <div class="floppyDrive" style="display: none;">
                </div>
                <div class="dvdDrive">
                    <div class="dvdDriveInner" style="display:none;">
                        <div class="selectHeading">DVD Drive</div>
                        <select>
                            <option value="-2">No Media</option>
                        </select>
                    </div>
                </div>
                <div class="networkAdapters"></div>
                <input type="button" class="ctrlAltDel ctrl-alt-del-button" value="Ctrl+Alt+Delete">
                    <a class="openInNewWindow open-in-new-window-link icon-link" href="https://labclient.labondemand.com/Instructions/e013c27b-7e28-4b7b-a514-ffe8a76c35a1#">Open in New Window</a>
            </div>
        </div></div>
                        <div id="containers"></div>
                        <div id="externalResources"></div>
                    </div>
                </div>
            </div>
            <div id="help-menu" class="modal-menu page-background-color" role="dialog" aria-modal="true" aria-labelledby="help-menu-title">
                <div class="modal-menu-title-bar primary-color-background">
                    <h2 id="help-menu-title" class="modal-menu-title">Help</h2>
                    <span><a class="close-modal-menu-button" tabindex="0" role="button" aria-label="Close" title="Close"></a></span>
                </div>
                <div class="modal-menu-content">
                    <div class="support-information accent-background">
                        <h3 class="title">
                            Support Information
                        </h3>
                        <table class="fields">
                            <tbody><tr>
                                <td class="fieldName">ID</td>
                                <td>55844333</td>
                            </tr>
                                <tr>
                                    <td class="fieldName">Host</td>
                                    <td>EU-HV22</td>
                                </tr>
                                <tr>
                                    <td class="fieldName">Datacenter</td>
                                    <td>Sweden Central</td>
                                </tr>
                        </tbody></table>
                    </div>

                    <div id="helpExtensions"></div>

                        <h3>FAQs</h3>
                        <a href="https://docs.skillable.com/docs/student-faq" target="_blank" class="external-link icon-link" aria-label="Frequently asked questions about the lab interface (opens a new window)">Frequently asked questions about the lab interface</a>

                    <h3>Other Help Options</h3>

                            <div class="link-list-item"><span id="supportTicketLink"><a class="cslink formsubmit topnav" href="javascript:void(0);" id="cslink_supportlink" target="_blank" aria-label="Help (opens a new window)">Help</a></span></div>



                        <div class="skillable-branding-block">
                            Powered by <a href="https://skillable.com/solutions" target="_blank" aria-label="Skillable (opens a new window)">Skillable</a>
                            <span class="skillable-links-separator">•</span>
                            <a target="_blank" href="https://www.g2.com/contributor/learnondemand-vs?secure%5Bpage_id%5D=Learnondemand-vs&amp;secure%5Brewards%5D=true&amp;secure%5Btoken%5D=839b2cb7a5a16a9e17bef29619706fee2de82770b3d2a6af507fee7a5ee54c7a" aria-label="Review Us (opens a new window)">Review Us</a>
                        </div>
                </div>
            </div>
            <div id="notifications-menu" class="modal-menu page-background-color" role="dialog" aria-modal="true" aria-labelledby="notifications-menu-title">
                <div class="modal-menu-title-bar primary-color-background">
                    <h2 id="notifications-menu-title" class="modal-menu-title">Notifications</h2>
                    <span><a class="close-modal-menu-button" tabindex="0" role="button" aria-label="Close" title="Close"></a></span>
                </div>     
                <div class="modal-menu-content">

                </div>
            </div>
            <div id="settings-menu" class="modal-menu page-background-color" role="dialog" aria-modal="true" aria-labelledby="settings-menu-title">
                <div class="modal-menu-title-bar primary-color-background">
                    <h2 id="settings-menu-title" class="modal-menu-title">Settings</h2>
                    <span><a class="close-modal-menu-button" tabindex="0" role="button" aria-label="Close" title="Close"></a></span>
                </div>
                <div class="modal-menu-content">
                    


                    <h3 class="settings-heading primary-color">Text Size</h3>

                    <div class="text-size-choice"><label><input type="radio" name="text-size" checked="" value="100"><span class="checkbox"></span>Standard</label></div>
                    <div id="text-size-choice-large" class="text-size-choice"><label><input type="radio" name="text-size" value="150"><span class="checkbox"></span>Large Text</label></div>
                    <div id="text-size-choice-extra-large" class="text-size-choice"><label><input type="radio" name="text-size" value="200"><span class="checkbox"></span>Extra Large Text</label></div>

                    <hr>

                        <h3 class="settings-heading primary-color"><label for="theme">Color Mode</label></h3>
                        <div>
                            <select id="theme">
                                    <option value="5" data-name="green" data-style-sheet-url="/theme/styles-v2?themeId=0&amp;mode=light">Light</option>
                                    <option value="20" data-name="dark" data-style-sheet-url="/theme/styles-v2?themeId=0&amp;mode=dark" selected="selected">Dark</option>
                                    <option value="4" data-name="gray" data-style-sheet-url="/theme/styles-v2?themeId=0&amp;mode=highcontrast">High Contrast</option>
                            </select>
                        </div>
                        <hr>

                        <h3 class="settings-heading primary-color">Actions</h3>
                        <div id="mainMenuExtensions"><div class="link-list-item"><a id="splitWindows" href="https://labclient.labondemand.com/Instructions/e013c27b-7e28-4b7b-a514-ffe8a76c35a1#" class="split-windows-link icon-link">Split Windows</a></div></div>                        

                </div>
            </div>
        </div>
        <div id="notificationContainer" role="region" aria-label="Notifications"></div>
    </div>

    <div id="fullScreenMessage" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="fullScreenMessageTitle" aria-describedby="fullScreenMessageText">
        <div id="fullScreenMessageMask"></div>
        <div id="fullScreenMessageIcon"></div>
        <div id="fullScreenMessageCenter" class="baseColor">
            <div id="fullScreenMessageTextWrapper">
                <span id="fullScreenMessageLoadingIcon" class="loadingAnimation-large"></span>
                <div id="fullScreenMessageTitle" role="heading" aria-level="1"></div>
                <div id="fullScreenMessageText" role="status"></div>
                <div id="fullScreenMessageButtonWrapper">
                    <span id="fullScreenMessageButtons"></span>
                    <input type="button" id="closeWindow" value="Close Window">
                </div>
                <div id="fullScreenProgressWrapper" style="display: none;">
                    <div id="fullScreenProgressText"></div>
                    <div id="fullScreenProgressBar" class="primary-color-low-opacity-background">
                        <div id="fullScreenProgressFill" class="primary-color-background"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="examResultDetails" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="ExamResultDetailsTitle">
        <div id="examResultDetailsHeader"></div>
        <div id="examResultDetailsCenter" class="baseColor">
            <div id="examResultDetailsWrapper">
                <div id="examResultDetailsTitle"></div>
                <div id="examResultDetailsText"></div>
                <div id="examResultDetailsButtonWrapper">
                    <span id="examResultDetailsButtons"></span>
                    <input type="button" id="closeWindow" value="Close Window">
                </div>
                <div id="exResultDetailsProgressWrapper" style="display: none;">
                    <div id="examResultDetailsProgressText"></div>
                    <div id="examResultDetailsProgressBar">
                        <div id="examResultDetailsProgressFill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <textarea id="copyInput" style="position: absolute; left:-10000px; top:-10000px; display:none;"></textarea>

    <script>
    var model = {
        id: 55844333,
        key: "e013c27b-7e28-4b7b-a514-ffe8a76c35a1",
        labProfileId: "182711",
        instructionsSetId: "313878",
        layoutVersion: 2,
        isPreview: false,
        isThemePreview: false,
previewKey: null,        helpTabLabel: "Help",
        monitor: false,
        takeControl: false,
        allowUserTransferSaves: false,
        userId: "3301544",
        userFullName: "Eusebiu Cozminca",
        publishKey: "pub-c-4b0a6a73-e675-4561-b40f-cee58350bb9f",
        subscribeKey: "sub-c-9c6a8086-0758-11eb-8c73-de77696b0464"
    };
        
    </script>

    
    <script>
        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for(let i = 0; i <ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
                }
            }
            return "";
        }
        // Checking to see if the disabledTracking cookie is set to drive pendo initialization for running playwrite tests without Pendo intervention.
        if(getCookie("disabledTracking") != "true") {
            (function (apiKey) {
            (function (p, e, n, d, o) {
                var v, w, x, y, z; o = p[d] = p[d] || {}; o._q = o._q || [];
                v = ['initialize', 'identify', 'updateOptions', 'pageLoad', 'track']; for (w = 0, x = v.length; w < x; ++w)(function (m) {
                    o[m] = o[m] || function () { o._q[m === v[0] ? 'unshift' : 'push']([m].concat([].slice.call(arguments, 0))); };
                })(v[w]);
                y = e.createElement(n); y.async = !0; y.src = 'https://content.analytics.learnondemandsystems.com/agent/static/' + apiKey + '/pendo.js';
                z = e.getElementsByTagName(n)[0]; z.parentNode.insertBefore(y, z);
            })(window, document, 'script', 'pendo');

            pendo.initialize({
                visitor: {
                    id: "lod-3301544",
                    platform: "lod",
                    iem: false,
                    labAuthor: false,
                    instructionsAuthor: false
                },
                account: {
                id: "4140",
                orgId: "2795",
                name: "Professional Services Contracted Projects",
                platform: "lod"
            }

            });
        })("536f12da-8330-4d47-64ff-6133e760c5d2");
        }
    </script>

    
    <script>
      (function(h,o,u,n,d) {
        h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
        d=o.createElement(u);d.async=1;d.src=n
        n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
        })(window,document,'script','https://www.datadoghq-browser-agent.com/us3/v6/datadog-logs.js','DD_LOGS')
      window.DD_LOGS.onReady(function() {
          window.DD_LOGS.init({
            clientToken: 'pub95df9c2772f25cae094492ee095d1bca',
            site: 'us3.datadoghq.com',
            env: 'prod',
            service: 'lab-client-frontend',
            forwardErrorsToLogs: true,
            telemetrySampleRate: 100,
            trackSessionAcrossSubdomains: true,
            forwardConsoleLogs: ['error', 'warn'],
          })
        })
    </script>

    
<script>
    let iFrameDetectorModel = {
        requireIFrame: false
    };

    function isInIFrame() {
        return (window === window.parent) ? false : true;
    }

    $(function () {
        if (iFrameDetectorModel.requireIFrame && !isInIFrame()) {
            window.location.href = "/AccessDenied";
        };
    });

</script>



</body></html>